<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteView - Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 18px; font-weight: 600; }

        #map { height: calc(100vh - 50px); width: 100%; margin-top: 50px; }

        .controls {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }

        .controls h2 { margin-bottom: 10px; font-size: 18px; }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 8px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }

        .search-box {
            margin-bottom: 10px;
        }
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result-item:hover { background: #f3f4f6; }
        .search-result-item:last-child { border-bottom: none; }

        .location-count {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }

        .modal h3 { margin-bottom: 16px; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .modal-buttons .btn { flex: 1; margin-bottom: 0; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }

        .popup-content h4 { margin-bottom: 8px; }
        .popup-content p { color: #666; font-size: 13px; margin-bottom: 4px; }
        .popup-buttons { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .popup-buttons button, .popup-buttons a { padding: 4px 10px; font-size: 12px; }

        /* Logs Modal */
        .logs-modal .modal-content { max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logs-header h3 { margin: 0; }
        .logs-search { margin-bottom: 12px; }
        .logs-search input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .logs-list { flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid #eee; border-radius: 8px; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; }
        .log-item:last-child { border-bottom: none; }
        .log-item h4 { font-size: 14px; margin-bottom: 4px; color: #1e293b; }
        .log-item p { font-size: 13px; color: #666; margin: 0; }
        .log-item .log-meta { font-size: 11px; color: #999; margin-top: 4px; }
        .log-empty { padding: 20px; text-align: center; color: #999; }
        .btn-orange { background: #f97316; }
        .btn-orange:hover { background: #ea580c; }
        .add-log-form { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        .add-log-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; margin-bottom: 8px; }
    </style>
</head>
<body>
    <header class="header">
        <h1>RouteView</h1>
    </header>
    <div id="map"></div>

    <div class="controls">
        <h2>RouteView</h2>
        <div class="search-box">
            <input type="text" id="place-search" placeholder="Search Google Maps...">
        </div>
        <div id="search-results" class="search-results" style="display:none;"></div>
        <button class="btn" onclick="startAddLocation()">+ Add Location Manually</button>
        <p class="location-count"><span id="count">0</span> locations</p>
    </div>

    <!-- Add/Edit Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Location</h3>
            <form id="location-form">
                <input type="hidden" id="location-id">
                <input type="hidden" id="location-lat">
                <input type="hidden" id="location-lng">

                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="location-name" required placeholder="e.g., Office Building Lobby">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="location-address" placeholder="e.g., 123 Main St">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="location-notes" placeholder="e.g., Key under mat, busy on Mondays"></textarea>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <p id="coords-display" style="color: #666; font-size: 13px;">Click on map to set</p>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Visit Logs Modal -->
    <div id="logs-modal" class="modal logs-modal">
        <div class="modal-content">
            <div class="logs-header">
                <h3 id="logs-title">Visit Logs</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeLogsModal()">Close</button>
            </div>
            <div class="logs-search">
                <input type="text" id="logs-search-input" placeholder="Search logs..." oninput="searchLogs()">
            </div>
            <div id="logs-list" class="logs-list">
                <div class="log-empty">No visits logged yet</div>
            </div>
            <div class="add-log-form">
                <textarea id="new-log-notes" placeholder="Add notes about this visit (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkIn()">Check In</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Google Places Search (using free Nominatim for now - no API key needed)
        const searchInput = document.getElementById('place-search');
        const searchResults = document.getElementById('search-results');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 3) {
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => searchPlaces(query), 300);
        });

        async function searchPlaces(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`
                );
                const results = await response.json();

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                } else {
                    searchResults.innerHTML = results.map(r => `
                        <div class="search-result-item" onclick="selectPlace('${r.display_name.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                            <strong>${r.display_name.split(',')[0]}</strong><br>
                            <small style="color:#666;">${r.display_name}</small>
                        </div>
                    `).join('');
                }
                searchResults.style.display = 'block';
            } catch (err) {
                console.error('Search error:', err);
            }
        }

        function selectPlace(name, lat, lng) {
            searchResults.style.display = 'none';
            searchInput.value = '';

            // Fly to location
            map.flyTo([lat, lng], 15);

            // Add temp marker and open modal
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);

            // Pre-fill modal
            document.getElementById('modal-title').textContent = 'Add Location';
            document.getElementById('location-id').value = '';
            document.getElementById('location-lat').value = lat;
            document.getElementById('location-lng').value = lng;
            document.getElementById('location-name').value = name.split(',')[0];
            document.getElementById('location-address').value = name;
            document.getElementById('location-notes').value = '';
            document.getElementById('coords-display').textContent = `${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}`;

            openModal();
        }

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.controls')) {
                searchResults.style.display = 'none';
            }
        });
    </script>
    <script>
        // Initialize map (centered on Europe - adjust as needed)
        const map = L.map('map').setView([41.9981, 21.4254], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let markers = {};
        let tempMarker = null;
        let isAddingLocation = false;

        // Load locations on start
        loadLocations();

        async function loadLocations() {
            const response = await fetch('/api/locations');
            const locations = await response.json();

            // Clear existing markers
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};

            locations.forEach(loc => {
                addMarker(loc);
            });

            document.getElementById('count').textContent = locations.length;

            // Fit bounds if there are locations
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(l => [l.latitude, l.longitude]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function addMarker(location) {
            const marker = L.marker([location.latitude, location.longitude])
                .addTo(map)
                .bindPopup(createPopupContent(location));
            markers[location.id] = marker;
        }

        function createPopupContent(location) {
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${location.latitude},${location.longitude}`;
            return `
                <div class="popup-content">
                    <h4>${location.name}</h4>
                    ${location.address ? `<p>üìç ${location.address}</p>` : ''}
                    ${location.notes ? `<p>üìù ${location.notes}</p>` : ''}
                    <div class="popup-buttons">
                        <a href="${directionsUrl}" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
                        <button class="btn btn-orange" onclick="openLogs(${location.id}, '${location.name.replace(/'/g, "\\'")}')">Logs</button>
                        <button class="btn" onclick="editLocation(${location.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteLocation(${location.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        function startAddLocation() {
            isAddingLocation = true;
            map.getContainer().style.cursor = 'crosshair';
            alert('Click on the map to place your location');
        }

        map.on('click', function(e) {
            if (!isAddingLocation) return;

            isAddingLocation = false;
            map.getContainer().style.cursor = '';

            // Remove temp marker if exists
            if (tempMarker) map.removeLayer(tempMarker);

            // Add temporary marker
            tempMarker = L.marker(e.latlng).addTo(map);

            // Open modal with coordinates
            document.getElementById('modal-title').textContent = 'Add Location';
            document.getElementById('location-id').value = '';
            document.getElementById('location-lat').value = e.latlng.lat;
            document.getElementById('location-lng').value = e.latlng.lng;
            document.getElementById('location-name').value = '';
            document.getElementById('location-address').value = '';
            document.getElementById('location-notes').value = '';
            document.getElementById('coords-display').textContent =
                `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;

            openModal();
        });

        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        async function editLocation(id) {
            const response = await fetch(`/api/locations/${id}`);
            const location = await response.json();

            document.getElementById('modal-title').textContent = 'Edit Location';
            document.getElementById('location-id').value = location.id;
            document.getElementById('location-lat').value = location.latitude;
            document.getElementById('location-lng').value = location.longitude;
            document.getElementById('location-name').value = location.name;
            document.getElementById('location-address').value = location.address || '';
            document.getElementById('location-notes').value = location.notes || '';
            document.getElementById('coords-display').textContent =
                `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;

            openModal();
        }

        async function deleteLocation(id) {
            if (!confirm('Delete this location?')) return;

            await fetch(`/api/locations/${id}`, { method: 'DELETE' });
            loadLocations();
        }

        document.getElementById('location-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('location-id').value;
            const data = {
                name: document.getElementById('location-name').value,
                address: document.getElementById('location-address').value || null,
                latitude: parseFloat(document.getElementById('location-lat').value),
                longitude: parseFloat(document.getElementById('location-lng').value),
                notes: document.getElementById('location-notes').value || null
            };

            const url = id ? `/api/locations/${id}` : '/api/locations';
            const method = id ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeModal();
            loadLocations();
        });

        // --- Visit Logs ---
        let currentLocationId = null;
        let currentLocationName = '';

        async function openLogs(locationId, locationName) {
            currentLocationId = locationId;
            currentLocationName = locationName;
            document.getElementById('logs-title').textContent = `Logs: ${locationName}`;
            document.getElementById('logs-search-input').value = '';
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            document.getElementById('logs-modal').classList.add('active');
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.remove('active');
            currentLocationId = null;
        }

        async function loadLogs(search = '') {
            const url = `/api/locations/${currentLocationId}/logs` + (search ? `?search=${encodeURIComponent(search)}` : '');
            const response = await fetch(url);
            const logs = await response.json();

            const listEl = document.getElementById('logs-list');
            if (logs.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No visits logged yet</div>';
            } else {
                listEl.innerHTML = logs.map(log => `
                    <div class="log-item">
                        <h4>${log.title}</h4>
                        ${log.notes ? `<p>${log.notes}</p>` : '<p style="font-style:italic;">No notes</p>'}
                        <div class="log-meta">${new Date(log.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        let searchLogsTimeout;
        function searchLogs() {
            clearTimeout(searchLogsTimeout);
            const query = document.getElementById('logs-search-input').value;
            searchLogsTimeout = setTimeout(() => loadLogs(query), 300);
        }

        async function checkIn() {
            const notes = document.getElementById('new-log-notes').value.trim();
            await fetch(`/api/locations/${currentLocationId}/logs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes || null })
            });
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
        }
    </script>
</body>
</html>
