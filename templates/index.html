<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteView - Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 18px; font-weight: 600; }

        #map { height: calc(100vh - 50px); width: 100%; margin-top: 50px; }

        .controls {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }

        .controls h2 { margin-bottom: 10px; font-size: 18px; }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 8px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }

        .search-box {
            margin-bottom: 10px;
        }
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result-item:hover { background: #f3f4f6; }
        .search-result-item:last-child { border-bottom: none; }

        .location-count {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }

        .modal h3 { margin-bottom: 16px; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .modal-buttons .btn { flex: 1; margin-bottom: 0; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }

        .popup-content h4 { margin-bottom: 8px; }
        .popup-content p { color: #666; font-size: 13px; margin-bottom: 4px; }
        .popup-buttons { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .popup-buttons button, .popup-buttons a { padding: 4px 10px; font-size: 12px; }

        /* Logs Modal */
        .logs-modal .modal-content { max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logs-header h3 { margin: 0; }
        .logs-search { margin-bottom: 12px; }
        .logs-search input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .logs-list { flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid #eee; border-radius: 8px; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; }
        .log-item:last-child { border-bottom: none; }
        .log-item h4 { font-size: 14px; margin-bottom: 4px; color: #1e293b; }
        .log-item p { font-size: 13px; color: #666; margin: 0; }
        .log-item .log-meta { font-size: 11px; color: #999; margin-top: 4px; }
        .log-empty { padding: 20px; text-align: center; color: #999; }
        .btn-orange { background: #f97316; }
        .btn-orange:hover { background: #ea580c; }
        .add-log-form { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        .add-log-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; margin-bottom: 8px; }

        /* Routes */
        .btn-purple { background: #7c3aed; }
        .btn-purple:hover { background: #6d28d9; }
        .route-list { margin-top: 10px; }
        .route-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .route-item:hover { background: #f9fafb; }
        .route-item h4 { font-size: 14px; margin-bottom: 2px; }
        .route-item small { color: #666; }

        /* Route Navigation Panel */
        .route-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 1000;
            display: none;
            min-width: 320px;
            max-width: 90%;
        }
        .route-nav.active { display: block; }
        .route-nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .route-nav-header h4 { margin: 0; font-size: 16px; }
        .route-nav-progress { font-size: 13px; color: #666; margin-bottom: 10px; }
        .route-nav-location { font-weight: 600; margin-bottom: 8px; }
        .route-nav-address { font-size: 13px; color: #666; margin-bottom: 12px; }
        .route-nav-buttons { display: flex; gap: 8px; }
        .route-nav-buttons .btn { flex: 1; margin: 0; padding: 12px; }

        /* Location selection for routes */
        .location-select-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-bottom: 12px; }
        .location-select-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .location-select-item:hover { background: #f9fafb; }
        .location-select-item.selected { background: #eff6ff; }
        .location-select-item:last-child { border-bottom: none; }
        .location-order { width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .location-select-item.selected .location-order { background: #2563eb; color: white; }

        /* Mobile Controls Toggle */
        .controls-toggle {
            display: none;
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .header { padding: 0 12px; }
            .header h1 { font-size: 16px; }

            .controls {
                position: fixed;
                top: 50px;
                right: 0;
                left: 0;
                max-width: none;
                border-radius: 0;
                padding: 12px;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
            }
            .controls.open { transform: translateY(0); }
            .controls h2 { display: none; }

            .controls-toggle { display: block; }
            .controls-toggle.open { display: none; }

            .btn {
                padding: 14px 16px;
                font-size: 16px;
            }

            .search-box input {
                padding: 12px;
                font-size: 16px;
            }

            /* Full-screen modals on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 16px;
                display: flex;
                flex-direction: column;
            }

            .logs-modal .modal-content,
            .modal-content[style*="max-width:450px"] {
                max-width: 100%;
                max-height: 100%;
            }

            .logs-list { max-height: none; flex: 1; }
            .location-select-list { max-height: none; flex: 1; }

            .form-group input,
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }

            /* Route navigation - full width at bottom */
            .route-nav {
                left: 0;
                right: 0;
                bottom: 0;
                transform: none;
                border-radius: 16px 16px 0 0;
                min-width: auto;
                max-width: none;
                padding: 16px;
            }

            .route-nav-buttons .btn {
                padding: 14px;
                font-size: 15px;
            }

            /* Bigger popup buttons */
            .popup-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .popup-buttons button,
            .popup-buttons a {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                text-align: center;
            }

            /* Filter results */
            .search-results {
                position: fixed;
                left: 12px;
                right: 12px;
                top: auto;
                max-height: 50vh;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 601px) and (max-width: 900px) {
            .controls { max-width: 280px; }
            .modal-content { max-width: 90%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>RouteView</h1>
    </header>
    <div id="map"></div>

    <button id="controls-toggle" class="controls-toggle" onclick="toggleControls()">Menu</button>

    <div id="controls" class="controls">
        <h2>RouteView</h2>
        <div class="search-box">
            <input type="text" id="location-filter" placeholder="Filter locations..." oninput="filterLocations()">
        </div>
        <div id="filter-results" class="search-results" style="display:none;"></div>
        <button class="btn" onclick="startAddLocation()">+ Add Location</button>
        <button class="btn btn-purple" onclick="openRoutesModal()">Routes</button>
        <button class="btn btn-orange" onclick="openClientsModal()">Clients</button>
        <p class="location-count"><span id="count">0</span> locations</p>
    </div>

    <!-- Route Navigation Panel -->
    <div id="route-nav" class="route-nav">
        <div class="route-nav-header">
            <h4 id="route-nav-title">Route Name</h4>
            <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="exitRoute()">Exit</button>
        </div>
        <div class="route-nav-progress">Stop <span id="route-current">1</span> of <span id="route-total">5</span></div>
        <div id="route-nav-location" class="route-nav-location">Location Name</div>
        <div id="route-nav-address" class="route-nav-address">Address here</div>
        <div class="route-nav-buttons">
            <button class="btn btn-secondary" onclick="prevStop()">Previous</button>
            <a id="route-directions-btn" href="#" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
            <button class="btn" onclick="nextStop()">Next</button>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Location</h3>
            <form id="location-form">
                <input type="hidden" id="location-id">
                <input type="hidden" id="location-lat">
                <input type="hidden" id="location-lng">

                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="location-name" required placeholder="e.g., Office Building Lobby">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="location-address" placeholder="e.g., 123 Main St">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="location-notes" placeholder="e.g., Key under mat, busy on Mondays"></textarea>
                </div>
                <div class="form-group">
                    <label>Client</label>
                    <select id="location-client" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                        <option value="">-- No Client --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <p id="coords-display" style="color: #666; font-size: 13px;">Click on map to set</p>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Visit Logs Modal -->
    <div id="logs-modal" class="modal logs-modal">
        <div class="modal-content">
            <div class="logs-header">
                <h3 id="logs-title">Visit Logs</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeLogsModal()">Close</button>
            </div>
            <div class="logs-search">
                <input type="text" id="logs-search-input" placeholder="Search logs..." oninput="searchLogs()">
            </div>
            <div id="logs-list" class="logs-list">
                <div class="log-empty">No visits logged yet</div>
            </div>
            <div class="add-log-form">
                <textarea id="new-log-notes" placeholder="Add notes about this visit (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkIn()">Check In</button>
            </div>
        </div>
    </div>

    <!-- Routes Modal -->
    <div id="routes-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="logs-header">
                <h3>Routes</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeRoutesModal()">Close</button>
            </div>
            <button class="btn" onclick="openCreateRouteModal()">+ Create New Route</button>
            <div id="routes-list" class="route-list">
                <div class="log-empty">No routes yet</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Route Modal -->
    <div id="route-form-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <h3 id="route-form-title">Create Route</h3>
            <div class="form-group">
                <label>Route Name *</label>
                <input type="text" id="route-name" placeholder="e.g., Monday Route">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="route-description" placeholder="e.g., Downtown locations">
            </div>
            <div class="form-group">
                <label>Select Locations (click in order)</label>
                <div id="location-select-list" class="location-select-list"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRouteFormModal()">Cancel</button>
                <button class="btn" onclick="saveRoute()">Save Route</button>
            </div>
        </div>
    </div>

    <!-- Clients Modal -->
    <div id="clients-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="logs-header">
                <h3>Clients</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeClientsModal()">Close</button>
            </div>
            <button class="btn" onclick="openClientFormModal()">+ Add Client</button>
            <div id="clients-list" class="route-list">
                <div class="log-empty">No clients yet</div>
            </div>
        </div>
    </div>

    <!-- Client Form Modal -->
    <div id="client-form-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <h3 id="client-form-title">Add Client</h3>
            <input type="hidden" id="client-id">
            <div class="form-group">
                <label>Client/Business Name *</label>
                <input type="text" id="client-name" placeholder="e.g., ABC Company">
            </div>
            <div class="form-group">
                <label>Contact Name</label>
                <input type="text" id="client-contact-name" placeholder="e.g., John Smith">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="client-phone" placeholder="e.g., +1 555-1234">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="client-email" placeholder="e.g., john@example.com">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="client-notes" placeholder="Any additional notes..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeClientFormModal()">Cancel</button>
                <button class="btn" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map (centered on Europe - adjust as needed)
        const map = L.map('map').setView([41.9981, 21.4254], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let markers = {};
        let tempMarker = null;
        let isAddingLocation = false;
        let allLocations = [];

        // Mobile controls toggle
        function toggleControls() {
            const controls = document.getElementById('controls');
            const toggle = document.getElementById('controls-toggle');
            controls.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        // Close controls when clicking on map (mobile)
        map.on('click', function() {
            if (window.innerWidth <= 600) {
                document.getElementById('controls').classList.remove('open');
                document.getElementById('controls-toggle').classList.remove('open');
            }
        });

        // Load locations on start
        loadLocations();

        // Filter existing locations
        function filterLocations() {
            const query = document.getElementById('location-filter').value.toLowerCase().trim();
            const resultsEl = document.getElementById('filter-results');

            if (query.length < 2) {
                resultsEl.style.display = 'none';
                return;
            }

            const matches = allLocations.filter(loc =>
                loc.name.toLowerCase().includes(query) ||
                (loc.address && loc.address.toLowerCase().includes(query))
            ).slice(0, 5);

            if (matches.length === 0) {
                resultsEl.innerHTML = '<div class="search-result-item">No matches</div>';
            } else {
                resultsEl.innerHTML = matches.map(loc => `
                    <div class="search-result-item" onclick="goToLocation(${loc.id})">
                        <strong>${loc.name}</strong><br>
                        <small style="color:#666;">${loc.address || 'No address'}</small>
                    </div>
                `).join('');
            }
            resultsEl.style.display = 'block';
        }

        function goToLocation(id) {
            document.getElementById('filter-results').style.display = 'none';
            document.getElementById('location-filter').value = '';
            const loc = allLocations.find(l => l.id === id);
            if (loc) {
                map.flyTo([loc.latitude, loc.longitude], 16);
                setTimeout(() => markers[id]?.openPopup(), 500);
            }
        }

        // Close filter results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.controls')) {
                document.getElementById('filter-results').style.display = 'none';
            }
        });

        async function loadLocations() {
            const response = await fetch('/api/locations');
            const locations = await response.json();
            allLocations = locations;

            // Clear existing markers
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};

            locations.forEach(loc => {
                addMarker(loc);
            });

            document.getElementById('count').textContent = locations.length;

            // Fit bounds if there are locations
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(l => [l.latitude, l.longitude]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function addMarker(location) {
            const marker = L.marker([location.latitude, location.longitude])
                .addTo(map)
                .bindPopup(createPopupContent(location));
            markers[location.id] = marker;
        }

        function createPopupContent(location) {
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${location.latitude},${location.longitude}`;
            return `
                <div class="popup-content">
                    <h4>${location.name}</h4>
                    ${location.address ? `<p>üìç ${location.address}</p>` : ''}
                    ${location.notes ? `<p>üìù ${location.notes}</p>` : ''}
                    <div class="popup-buttons">
                        <a href="${directionsUrl}" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
                        <button class="btn btn-orange" onclick="openLogs(${location.id}, '${location.name.replace(/'/g, "\\'")}')">Logs</button>
                        <button class="btn" onclick="editLocation(${location.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteLocation(${location.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        function startAddLocation() {
            isAddingLocation = true;
            map.getContainer().style.cursor = 'crosshair';
            alert('Click on the map to place your location');
        }

        map.on('click', function(e) {
            if (!isAddingLocation) return;

            isAddingLocation = false;
            map.getContainer().style.cursor = '';

            // Remove temp marker if exists
            if (tempMarker) map.removeLayer(tempMarker);

            // Add temporary marker
            tempMarker = L.marker(e.latlng).addTo(map);

            // Open modal with coordinates
            document.getElementById('modal-title').textContent = 'Add Location';
            document.getElementById('location-id').value = '';
            document.getElementById('location-lat').value = e.latlng.lat;
            document.getElementById('location-lng').value = e.latlng.lng;
            document.getElementById('location-name').value = '';
            document.getElementById('location-address').value = '';
            document.getElementById('location-notes').value = '';
            document.getElementById('location-client').value = '';
            document.getElementById('coords-display').textContent =
                `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;

            openModal();
        });

        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        async function editLocation(id) {
            const response = await fetch(`/api/locations/${id}`);
            const location = await response.json();

            document.getElementById('modal-title').textContent = 'Edit Location';
            document.getElementById('location-id').value = location.id;
            document.getElementById('location-lat').value = location.latitude;
            document.getElementById('location-lng').value = location.longitude;
            document.getElementById('location-name').value = location.name;
            document.getElementById('location-address').value = location.address || '';
            document.getElementById('location-notes').value = location.notes || '';
            document.getElementById('location-client').value = location.client_id || '';
            document.getElementById('coords-display').textContent =
                `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;

            openModal();
        }

        async function deleteLocation(id) {
            if (!confirm('Delete this location?')) return;

            await fetch(`/api/locations/${id}`, { method: 'DELETE' });
            loadLocations();
        }

        document.getElementById('location-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('location-id').value;
            const clientSelect = document.getElementById('location-client');
            const clientId = clientSelect.value ? parseInt(clientSelect.value) : null;

            const data = {
                name: document.getElementById('location-name').value,
                address: document.getElementById('location-address').value || null,
                latitude: parseFloat(document.getElementById('location-lat').value),
                longitude: parseFloat(document.getElementById('location-lng').value),
                notes: document.getElementById('location-notes').value || null,
                client_id: clientId
            };

            const url = id ? `/api/locations/${id}` : '/api/locations';
            const method = id ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeModal();
            loadLocations();
        });

        // --- Visit Logs ---
        let currentLocationId = null;
        let currentLocationName = '';

        async function openLogs(locationId, locationName) {
            currentLocationId = locationId;
            currentLocationName = locationName;
            document.getElementById('logs-title').textContent = `Logs: ${locationName}`;
            document.getElementById('logs-search-input').value = '';
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            document.getElementById('logs-modal').classList.add('active');
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.remove('active');
            currentLocationId = null;
        }

        async function loadLogs(search = '') {
            const url = `/api/locations/${currentLocationId}/logs` + (search ? `?search=${encodeURIComponent(search)}` : '');
            const response = await fetch(url);
            const logs = await response.json();

            const listEl = document.getElementById('logs-list');
            if (logs.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No visits logged yet</div>';
            } else {
                listEl.innerHTML = logs.map(log => `
                    <div class="log-item">
                        <h4>${log.title}</h4>
                        ${log.notes ? `<p>${log.notes}</p>` : '<p style="font-style:italic;">No notes</p>'}
                        <div class="log-meta">${new Date(log.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        let searchLogsTimeout;
        function searchLogs() {
            clearTimeout(searchLogsTimeout);
            const query = document.getElementById('logs-search-input').value;
            searchLogsTimeout = setTimeout(() => loadLogs(query), 300);
        }

        async function checkIn() {
            const notes = document.getElementById('new-log-notes').value.trim();
            await fetch(`/api/locations/${currentLocationId}/logs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes || null })
            });
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
        }

        // --- Routes ---
        let selectedLocationIds = [];
        let editingRouteId = null;
        let activeRoute = null;
        let currentStopIndex = 0;

        async function openRoutesModal() {
            await loadRoutes();
            document.getElementById('routes-modal').classList.add('active');
        }

        function closeRoutesModal() {
            document.getElementById('routes-modal').classList.remove('active');
        }

        async function loadRoutes() {
            const response = await fetch('/api/routes');
            const routes = await response.json();

            const listEl = document.getElementById('routes-list');
            if (routes.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No routes yet</div>';
            } else {
                listEl.innerHTML = routes.map(r => `
                    <div class="route-item" onclick="startRoute(${r.id})">
                        <h4>${r.name}</h4>
                        <small>${r.location_count} stops${r.description ? ' ‚Ä¢ ' + r.description : ''}</small>
                    </div>
                `).join('');
            }
        }

        function openCreateRouteModal() {
            editingRouteId = null;
            selectedLocationIds = [];
            document.getElementById('route-form-title').textContent = 'Create Route';
            document.getElementById('route-name').value = '';
            document.getElementById('route-description').value = '';
            renderLocationSelectList();
            closeRoutesModal();
            document.getElementById('route-form-modal').classList.add('active');
        }

        function closeRouteFormModal() {
            document.getElementById('route-form-modal').classList.remove('active');
        }

        function renderLocationSelectList() {
            const listEl = document.getElementById('location-select-list');
            listEl.innerHTML = allLocations.map(loc => {
                const idx = selectedLocationIds.indexOf(loc.id);
                const isSelected = idx !== -1;
                return `
                    <div class="location-select-item ${isSelected ? 'selected' : ''}" onclick="toggleLocationSelect(${loc.id})">
                        <div class="location-order">${isSelected ? idx + 1 : ''}</div>
                        <div>
                            <strong>${loc.name}</strong><br>
                            <small style="color:#666;">${loc.address || 'No address'}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleLocationSelect(locId) {
            const idx = selectedLocationIds.indexOf(locId);
            if (idx === -1) {
                selectedLocationIds.push(locId);
            } else {
                selectedLocationIds.splice(idx, 1);
            }
            renderLocationSelectList();
        }

        async function saveRoute() {
            const name = document.getElementById('route-name').value.trim();
            if (!name) {
                alert('Please enter a route name');
                return;
            }
            if (selectedLocationIds.length === 0) {
                alert('Please select at least one location');
                return;
            }

            const data = {
                name,
                description: document.getElementById('route-description').value.trim() || null,
                location_ids: selectedLocationIds
            };

            const url = editingRouteId ? `/api/routes/${editingRouteId}` : '/api/routes';
            const method = editingRouteId ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeRouteFormModal();
            openRoutesModal();
        }

        async function startRoute(routeId) {
            const response = await fetch(`/api/routes/${routeId}`);
            activeRoute = await response.json();
            currentStopIndex = 0;

            if (activeRoute.locations.length === 0) {
                alert('This route has no locations');
                return;
            }

            closeRoutesModal();
            updateRouteNav();
            document.getElementById('route-nav').classList.add('active');
        }

        function updateRouteNav() {
            const stop = activeRoute.locations[currentStopIndex];
            const loc = stop.location;

            document.getElementById('route-nav-title').textContent = activeRoute.name;
            document.getElementById('route-current').textContent = currentStopIndex + 1;
            document.getElementById('route-total').textContent = activeRoute.locations.length;
            document.getElementById('route-nav-location').textContent = loc.name;
            document.getElementById('route-nav-address').textContent = loc.address || 'No address';
            document.getElementById('route-directions-btn').href =
                `https://www.google.com/maps/dir/?api=1&destination=${loc.latitude},${loc.longitude}`;

            map.flyTo([loc.latitude, loc.longitude], 16);
            setTimeout(() => markers[loc.id]?.openPopup(), 500);
        }

        function prevStop() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                updateRouteNav();
            }
        }

        function nextStop() {
            if (currentStopIndex < activeRoute.locations.length - 1) {
                currentStopIndex++;
                updateRouteNav();
            } else {
                alert('Route complete!');
            }
        }

        function exitRoute() {
            document.getElementById('route-nav').classList.remove('active');
            activeRoute = null;
            currentStopIndex = 0;
        }

        // --- Clients ---
        let allClients = [];
        let editingClientId = null;

        async function loadClients() {
            const response = await fetch('/api/clients');
            allClients = await response.json();
            updateClientDropdown();
        }

        function updateClientDropdown() {
            const select = document.getElementById('location-client');
            select.innerHTML = '<option value="">-- No Client --</option>' +
                allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function openClientsModal() {
            await loadClients();
            renderClientsList();
            document.getElementById('clients-modal').classList.add('active');
        }

        function closeClientsModal() {
            document.getElementById('clients-modal').classList.remove('active');
        }

        function renderClientsList() {
            const listEl = document.getElementById('clients-list');
            if (allClients.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No clients yet</div>';
            } else {
                listEl.innerHTML = allClients.map(c => `
                    <div class="route-item" onclick="editClient(${c.id})">
                        <h4>${c.name}</h4>
                        <small>${c.location_count} locations${c.contact_name ? ' ‚Ä¢ ' + c.contact_name : ''}</small>
                    </div>
                `).join('');
            }
        }

        function openClientFormModal() {
            editingClientId = null;
            document.getElementById('client-form-title').textContent = 'Add Client';
            document.getElementById('client-id').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-contact-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-notes').value = '';
            closeClientsModal();
            document.getElementById('client-form-modal').classList.add('active');
        }

        function closeClientFormModal() {
            document.getElementById('client-form-modal').classList.remove('active');
        }

        async function editClient(clientId) {
            const response = await fetch(`/api/clients/${clientId}`);
            const client = await response.json();

            editingClientId = clientId;
            document.getElementById('client-form-title').textContent = 'Edit Client';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-contact-name').value = client.contact_name || '';
            document.getElementById('client-phone').value = client.contact_phone || '';
            document.getElementById('client-email').value = client.contact_email || '';
            document.getElementById('client-notes').value = client.notes || '';

            closeClientsModal();
            document.getElementById('client-form-modal').classList.add('active');
        }

        async function saveClient() {
            const name = document.getElementById('client-name').value.trim();
            if (!name) {
                alert('Please enter a client name');
                return;
            }

            const data = {
                name,
                contact_name: document.getElementById('client-contact-name').value.trim() || null,
                contact_phone: document.getElementById('client-phone').value.trim() || null,
                contact_email: document.getElementById('client-email').value.trim() || null,
                notes: document.getElementById('client-notes').value.trim() || null
            };

            const url = editingClientId ? `/api/clients/${editingClientId}` : '/api/clients';
            const method = editingClientId ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeClientFormModal();
            await loadClients();
            openClientsModal();
        }

        // Load clients on start
        loadClients();
    </script>
</body>
</html>
