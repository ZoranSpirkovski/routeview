<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteView - Client Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 18px; font-weight: 600; }

        #map {
            height: calc(100vh - 50px);
            margin-top: 50px;
            margin-left: 320px;
            width: calc(100% - 320px);
        }

        /* Left Panel */
        .left-panel {
            position: fixed;
            top: 50px;
            left: 0;
            bottom: 0;
            width: 320px;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .panel-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .mode-toggle {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }

        .mode-btn:hover { background: rgba(255,255,255,0.5); }
        .mode-btn.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: #2563eb;
        }

        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-search {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .panel-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .client-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
        }

        .client-item:hover { background: #f9fafb; }
        .client-item.highlighted {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .client-item-info { flex: 1; min-width: 0; }
        .client-item-name { font-weight: 500; margin-bottom: 2px; }
        .client-item-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .client-item-last { font-size: 11px; color: #999; margin-top: 2px; }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-green { background: #22c55e; }
        .status-orange { background: #f97316; }
        .status-red { background: #ef4444; }
        .status-never { background: #9ca3af; }

        .panel-footer {
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Execution mode styles */
        .exec-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .exec-header h4 { margin: 0 0 4px 0; }
        .exec-header p { margin: 0; font-size: 13px; color: #666; }

        .exec-actions {
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .exec-actions textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 60px;
            resize: vertical;
        }

        /* Route stop items */
        .route-stop {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #eee;
        }
        .route-stop:hover { background: #f9fafb; }
        .route-stop.current { background: #eff6ff; border-color: #3b82f6; }
        .route-stop.completed { opacity: 0.6; }
        .stop-number {
            width: 28px;
            height: 28px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
        }
        .route-stop.current .stop-number { background: #2563eb; color: white; }
        .route-stop.completed .stop-number { background: #22c55e; color: white; }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #999;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 0;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-purple { background: #7c3aed; }
        .btn-purple:hover { background: #6d28d9; }
        .btn-orange { background: #f97316; }
        .btn-orange:hover { background: #ea580c; }

        /* Address autocomplete dropdown */
        .address-autocomplete {
            position: relative;
        }
        .address-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }
        .address-results.active { display: block; }
        .address-result-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        .address-result-item:hover { background: #f3f4f6; }
        .address-result-item:last-child { border-bottom: none; }
        .address-loading {
            padding: 10px 12px;
            color: #666;
            font-style: italic;
        }

        /* Pick on map button states */
        .btn-pick-map { background: #6366f1; }
        .btn-pick-map:hover { background: #4f46e5; }

        /* Floating cancel button when picking on map */
        .pick-map-overlay {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
        }
        .pick-map-overlay.active { display: block; }
        .pick-map-overlay p { margin-bottom: 12px; font-weight: 500; }
        .pick-map-overlay .btn { width: auto; margin: 0; }

        .coords-display {
            color: #666;
            font-size: 13px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 { margin-bottom: 16px; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .modal-buttons .btn { flex: 1; margin-bottom: 0; }

        .popup-content h4 { margin-bottom: 8px; }
        .popup-content p { color: #666; font-size: 13px; margin-bottom: 4px; }
        .popup-buttons { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .popup-buttons button, .popup-buttons a { padding: 4px 10px; font-size: 12px; }

        /* Logs Modal */
        .logs-modal .modal-content { max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logs-header h3 { margin: 0; }
        .logs-search { margin-bottom: 12px; }
        .logs-search input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .logs-list { flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid #eee; border-radius: 8px; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; }
        .log-item:last-child { border-bottom: none; }
        .log-item h4 { font-size: 14px; margin-bottom: 4px; color: #1e293b; }
        .log-item p { font-size: 13px; color: #666; margin: 0; }
        .log-item .log-meta { font-size: 11px; color: #999; margin-top: 4px; }
        .log-empty { padding: 20px; text-align: center; color: #999; }
        .add-log-form { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        .add-log-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; margin-bottom: 8px; }

        /* Routes */
        .route-list { margin-top: 10px; }
        .route-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .route-item:hover { background: #f9fafb; }
        .route-item h4 { font-size: 14px; margin-bottom: 2px; }
        .route-item small { color: #666; }

        /* Client selection for routes */
        .client-select-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-bottom: 12px; }
        .client-select-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .client-select-item:hover { background: #f9fafb; }
        .client-select-item.selected { background: #eff6ff; }
        .client-select-item:last-child { border-bottom: none; }
        .client-order { width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .client-select-item.selected .client-order { background: #2563eb; color: white; }

        /* Mobile toggle button */
        .panel-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            background: #2563eb;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* Mobile: panel slides overlay */
        @media (max-width: 768px) {
            .left-panel {
                width: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .left-panel.open { transform: translateX(0); }
            #map { margin-left: 0; width: 100%; }

            .panel-toggle { display: block; }

            .header { padding: 0 12px; }
            .header h1 { font-size: 16px; }

            .btn {
                padding: 14px 16px;
                font-size: 16px;
            }

            /* Full-screen modals on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 16px;
                display: flex;
                flex-direction: column;
            }

            .logs-modal .modal-content,
            .modal-content[style*="max-width:450px"] {
                max-width: 100%;
                max-height: 100%;
            }

            .logs-list { max-height: none; flex: 1; }
            .client-select-list { max-height: none; flex: 1; }

            .form-group input,
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }

            /* Bigger popup buttons */
            .popup-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .popup-buttons button,
            .popup-buttons a {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                text-align: center;
            }

            /* Address autocomplete on mobile */
            .address-results {
                position: fixed;
                left: 16px;
                right: 16px;
                top: auto;
                max-height: 40vh;
            }
        }

        @media (min-width: 769px) {
            .panel-toggle { display: none; }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 900px) {
            .modal-content { max-width: 90%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>RouteView</h1>
    </header>
    <div id="map"></div>

    <!-- Left Panel -->
    <div id="left-panel" class="left-panel">
        <!-- Panel Header with Mode Toggle -->
        <div class="panel-header">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="planning" onclick="setMode('planning')">Planning</button>
                <button class="mode-btn" data-mode="execution" onclick="setMode('execution')">Execution</button>
            </div>
        </div>

        <!-- Planning Mode Content -->
        <div id="planning-content" class="panel-content">
            <div class="panel-search">
                <input type="text" id="client-search" placeholder="Search clients..." oninput="filterClientList()">
            </div>
            <div style="padding: 4px 12px; font-size: 12px; color: #666; display: flex; justify-content: space-between; align-items: center;">
                <span>Showing <span id="count">0</span> clients</span>
                <a href="#" id="show-all-link" style="color: #2563eb; text-decoration: none; display: none;" onclick="showAllClients(); return false;">Show all</a>
            </div>
            <div id="client-list" class="client-list">
                <!-- Client items rendered here -->
            </div>
            <div class="panel-footer">
                <button class="btn" onclick="startAddClient()">+ Add Client</button>
                <button class="btn btn-purple" onclick="openRoutesModal()">Manage Routes</button>
            </div>
        </div>

        <!-- Execution Mode Content -->
        <div id="execution-content" class="panel-content" style="display:none;">
            <div class="exec-header">
                <h4 id="exec-route-name">No route selected</h4>
                <p id="exec-route-progress"></p>
            </div>
            <div id="route-stops-list" class="client-list">
                <!-- Route stops rendered here -->
            </div>
            <div class="exec-actions" id="exec-actions" style="display:none;">
                <textarea id="exec-checkin-notes" placeholder="Check-in notes (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkInFromPanel()">Check In</button>
                <a id="exec-directions-btn" href="#" target="_blank" class="btn btn-purple" style="text-decoration:none;text-align:center;">Get Directions</a>
            </div>
            <div class="panel-footer">
                <button class="btn btn-secondary" onclick="exitRouteExecution()">Exit Route</button>
            </div>
        </div>
    </div>

    <!-- Mobile Panel Toggle -->
    <button class="panel-toggle" onclick="togglePanel()">Menu</button>

    <!-- Add/Edit Client Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Client</h3>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <input type="hidden" id="client-lat">
                <input type="hidden" id="client-lng">

                <div class="form-group">
                    <label>Client/Business Name *</label>
                    <input type="text" id="client-name" required placeholder="e.g., ABC Company">
                </div>
                <div class="form-group address-autocomplete">
                    <label>Address *</label>
                    <input type="text" id="client-address" required placeholder="Start typing an address..." autocomplete="off">
                    <div id="address-results" class="address-results"></div>
                </div>
                <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" id="client-contact-name" placeholder="e.g., John Smith">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="client-phone" placeholder="e.g., +1 555-1234">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="client-email" placeholder="e.g., john@example.com">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="client-notes" placeholder="Any additional notes..."></textarea>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <div id="coords-display" class="coords-display">Not set - enter address or pick on map</div>
                </div>

                <button type="button" id="pick-map-btn" class="btn btn-pick-map" onclick="togglePickOnMap()">Pick on Map</button>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Visit Logs Modal -->
    <div id="logs-modal" class="modal logs-modal">
        <div class="modal-content">
            <div class="logs-header">
                <h3 id="logs-title">Visit Logs</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeLogsModal()">Close</button>
            </div>
            <div class="logs-search">
                <input type="text" id="logs-search-input" placeholder="Search logs..." oninput="searchLogs()">
            </div>
            <div id="logs-list" class="logs-list">
                <div class="log-empty">No visits logged yet</div>
            </div>
            <div class="add-log-form">
                <textarea id="new-log-notes" placeholder="Add notes about this visit (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkIn()">Check In</button>
            </div>
        </div>
    </div>

    <!-- Routes Modal -->
    <div id="routes-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="logs-header">
                <h3>Routes</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeRoutesModal()">Close</button>
            </div>
            <button class="btn" onclick="openCreateRouteModal()">+ Create New Route</button>
            <div id="routes-list" class="route-list">
                <div class="log-empty">No routes yet</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Route Modal -->
    <div id="route-form-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <h3 id="route-form-title">Create Route</h3>
            <div class="form-group">
                <label>Route Name *</label>
                <input type="text" id="route-name" placeholder="e.g., Monday Route">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="route-description" placeholder="e.g., Downtown clients">
            </div>
            <div class="form-group">
                <label>Select Clients (click in order)</label>
                <div id="client-select-list" class="client-select-list"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRouteFormModal()">Cancel</button>
                <button class="btn" onclick="saveRoute()">Save Route</button>
            </div>
        </div>
    </div>

    <!-- Pick on Map Overlay -->
    <div id="pick-map-overlay" class="pick-map-overlay">
        <p>Click on the map to set location</p>
        <button class="btn btn-secondary" onclick="cancelPickOnMap()">Cancel</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // App state management
        let appState = {
            mode: 'planning',
            clientsWithStatus: [],
            filteredClients: [],
            highlightedClientId: null,
            activeRoute: null,
            currentStopIndex: 0,
            completedStops: []
        };

        // Initialize map (centered on Europe - adjust as needed)
        const map = L.map('map').setView([41.9981, 21.4254], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let clientMarkers = {};
        let tempMarker = null;
        let isPickingOnMap = false;
        let allClients = [];
        let addressSearchTimeout = null;

        // Color-coded markers based on service status
        function getStatusColor(status) {
            const colors = {
                green: '#22c55e',
                orange: '#f97316',
                red: '#ef4444',
                never: '#9ca3af'
            };
            return colors[status] || colors.never;
        }

        function createColoredMarker(client) {
            const color = getStatusColor(client.service_status);

            return L.circleMarker([client.latitude, client.longitude], {
                radius: 10,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            });
        }

        function highlightClientInList(clientId) {
            appState.highlightedClientId = clientId;

            // Update visual highlight in list
            document.querySelectorAll('.client-item').forEach(el => {
                el.classList.toggle('highlighted', el.dataset.id == clientId);
            });

            // Scroll into view
            const element = document.querySelector(`.client-item[data-id="${clientId}"]`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Mobile panel toggle
        function togglePanel() {
            document.getElementById('left-panel').classList.toggle('open');
        }

        // Close panel when clicking on map (mobile)
        map.on('click', function(e) {
            if (window.innerWidth <= 768) {
                document.getElementById('left-panel').classList.remove('open');
            }

            // Handle pick on map mode
            if (isPickingOnMap) {
                handleMapClick(e);
            }
        });

        // Mode switching
        function setMode(mode) {
            appState.mode = mode;

            // Update toggle buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Show/hide content
            document.getElementById('planning-content').style.display = mode === 'planning' ? 'flex' : 'none';
            document.getElementById('execution-content').style.display = mode === 'execution' ? 'flex' : 'none';

            // If switching to execution and no route, show route selection
            if (mode === 'execution' && !appState.activeRoute) {
                openRoutesModal();
            }
        }

        // Load clients with status on start
        loadClientsWithStatus();

        // Load clients with service status
        async function loadClientsWithStatus() {
            try {
                const response = await fetch('/api/clients/with-status');
                appState.clientsWithStatus = await response.json();
                appState.filteredClients = [...appState.clientsWithStatus];
                allClients = appState.clientsWithStatus;
                renderClientList();
                renderMarkers();
                setupMapSync(); // Initialize bidirectional sync after clients are loaded
            } catch (err) {
                // Fallback to regular clients endpoint
                const response = await fetch('/api/clients');
                const clients = await response.json();
                appState.clientsWithStatus = clients.map(c => ({
                    ...c,
                    service_status: 'never',
                    last_serviced: null
                }));
                appState.filteredClients = [...appState.clientsWithStatus];
                allClients = appState.clientsWithStatus;
                renderClientList();
                renderMarkers();
                setupMapSync(); // Initialize bidirectional sync after clients are loaded
            }
        }

        // Render client list in left panel
        function renderClientList() {
            const listEl = document.getElementById('client-list');
            const clients = appState.filteredClients;

            if (clients.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No clients found</div>';
                return;
            }

            listEl.innerHTML = clients.map(client => `
                <div class="client-item ${appState.highlightedClientId === client.id ? 'highlighted' : ''}"
                     data-id="${client.id}"
                     onclick="handleClientClick(${client.id})">
                    <div class="status-dot status-${client.service_status || 'never'}"></div>
                    <div class="client-item-info">
                        <div class="client-item-name">${client.name}</div>
                        <div class="client-item-address">${client.address || 'No address'}</div>
                        <div class="client-item-last">${formatLastServiced(client.last_serviced)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatLastServiced(dateString) {
            if (!dateString) return 'Never serviced';
            const date = new Date(dateString);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Serviced today';
            if (diffDays === 1) return 'Serviced yesterday';
            if (diffDays < 7) return `Serviced ${diffDays} days ago`;
            if (diffDays < 30) return `Serviced ${Math.floor(diffDays / 7)} weeks ago`;
            return `Serviced ${Math.floor(diffDays / 30)} months ago`;
        }

        // Filter client list in left panel
        function filterClientList() {
            const query = document.getElementById('client-search').value.toLowerCase().trim();

            if (query.length === 0) {
                // If no search, show clients in viewport
                filterClientsByViewport();
                return;
            }

            // If searching, search ALL clients (not just viewport)
            appState.filteredClients = appState.clientsWithStatus.filter(client =>
                client.name.toLowerCase().includes(query) ||
                (client.address && client.address.toLowerCase().includes(query)) ||
                (client.contact_name && client.contact_name.toLowerCase().includes(query))
            );

            renderClientList();

            // Update count
            const countEl = document.getElementById('count');
            if (countEl) {
                countEl.textContent = `${appState.filteredClients.length} matches`;
            }

            // Hide "Show all" link when searching
            const showAllLink = document.getElementById('show-all-link');
            if (showAllLink) {
                showAllLink.style.display = 'none';
            }
        }

        // Handle client click in left panel
        function handleClientClick(clientId) {
            const client = appState.clientsWithStatus.find(c => c.id === clientId);
            if (!client || !client.latitude || !client.longitude) return;

            // Highlight in list
            highlightClientInList(clientId);

            // Pan map to client with smooth animation
            map.flyTo([client.latitude, client.longitude], 16, { duration: 0.5 });

            // Open popup after animation completes
            setTimeout(() => {
                if (clientMarkers[clientId]) {
                    clientMarkers[clientId].openPopup();
                }
            }, 600);

            // Close mobile panel
            if (window.innerWidth <= 768) {
                document.getElementById('left-panel').classList.remove('open');
            }
        }

        // Render markers on map
        function renderMarkers() {
            // Clear existing markers
            Object.values(clientMarkers).forEach(m => map.removeLayer(m));
            clientMarkers = {};

            // Add markers for clients with coordinates
            const clientsWithCoords = appState.clientsWithStatus.filter(c => c.latitude && c.longitude);

            clientsWithCoords.forEach(client => {
                const marker = createColoredMarker(client);
                marker.addTo(map);
                marker.bindPopup(createPopupContent(client));

                // Sync marker click with list
                marker.on('click', () => {
                    highlightClientInList(client.id);
                });

                clientMarkers[client.id] = marker;
            });

            // Fit bounds if there are clients
            if (clientsWithCoords.length > 0) {
                const bounds = L.latLngBounds(clientsWithCoords.map(c => [c.latitude, c.longitude]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Update count
            document.getElementById('count')?.textContent = appState.clientsWithStatus.length;
        }

        function createPopupContent(client) {
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${client.latitude},${client.longitude}`;
            const statusColor = getStatusColor(client.service_status);
            const statusLabel = {
                green: 'Recently serviced',
                orange: 'Due soon',
                red: 'Overdue',
                never: 'Never serviced'
            }[client.service_status] || 'Never serviced';

            return `
                <div class="popup-content">
                    <h4>${client.name}</h4>
                    <p style="margin-bottom:6px;">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusColor};margin-right:6px;"></span>
                        <strong>${statusLabel}</strong>
                        ${client.last_serviced ? ` - ${formatLastServiced(client.last_serviced)}` : ''}
                    </p>
                    ${client.address ? `<p style="margin-bottom:4px;">${client.address}</p>` : ''}
                    ${client.contact_name ? `<p style="margin-bottom:2px;"><strong>Contact:</strong> ${client.contact_name}</p>` : ''}
                    ${client.contact_phone ? `<p style="margin-bottom:2px;"><strong>Phone:</strong> <a href="tel:${client.contact_phone}">${client.contact_phone}</a></p>` : ''}
                    ${client.contact_email ? `<p style="margin-bottom:2px;"><strong>Email:</strong> <a href="mailto:${client.contact_email}">${client.contact_email}</a></p>` : ''}
                    ${client.notes ? `<p style="margin-top:6px;font-style:italic;color:#666;">${client.notes}</p>` : ''}
                    <div class="popup-buttons">
                        <a href="${directionsUrl}" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
                        <button class="btn btn-orange" onclick="openLogs(${client.id}, '${client.name.replace(/'/g, "\\'")}')">Logs</button>
                        <button class="btn" onclick="editClient(${client.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteClient(${client.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        // Close address results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-autocomplete')) {
                document.getElementById('address-results').classList.remove('active');
            }
        });

        // Open Add Client modal directly
        function startAddClient() {
            document.getElementById('modal-title').textContent = 'Add Client';
            document.getElementById('client-id').value = '';
            document.getElementById('client-lat').value = '';
            document.getElementById('client-lng').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-address').value = '';
            document.getElementById('client-contact-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-notes').value = '';
            document.getElementById('coords-display').textContent = 'Not set - enter address or pick on map';
            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            openModal();
        }

        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('pick-map-overlay').classList.remove('active');
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        async function editClient(id) {
            const response = await fetch(`/api/clients/${id}`);
            const client = await response.json();

            document.getElementById('modal-title').textContent = 'Edit Client';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-lat').value = client.latitude || '';
            document.getElementById('client-lng').value = client.longitude || '';
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-contact-name').value = client.contact_name || '';
            document.getElementById('client-phone').value = client.contact_phone || '';
            document.getElementById('client-email').value = client.contact_email || '';
            document.getElementById('client-notes').value = client.notes || '';

            if (client.latitude && client.longitude) {
                document.getElementById('coords-display').textContent =
                    `${client.latitude.toFixed(6)}, ${client.longitude.toFixed(6)}`;
            } else {
                document.getElementById('coords-display').textContent = 'Not set - enter address or pick on map';
            }

            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            openModal();
        }

        async function deleteClient(id) {
            if (!confirm('Delete this client?')) return;

            await fetch(`/api/clients/${id}`, { method: 'DELETE' });
            loadClientsWithStatus();
        }

        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('client-id').value;
            const lat = document.getElementById('client-lat').value;
            const lng = document.getElementById('client-lng').value;

            if (!lat || !lng) {
                alert('Please set a location by entering an address or picking on the map');
                return;
            }

            const data = {
                name: document.getElementById('client-name').value,
                address: document.getElementById('client-address').value || null,
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                contact_name: document.getElementById('client-contact-name').value || null,
                contact_phone: document.getElementById('client-phone').value || null,
                contact_email: document.getElementById('client-email').value || null,
                notes: document.getElementById('client-notes').value || null
            };

            const url = id ? `/api/clients/${id}` : '/api/clients';
            const method = id ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeModal();
            loadClientsWithStatus();
        });

        // --- Address Autocomplete with Nominatim ---
        const addressInput = document.getElementById('client-address');
        const addressResultsEl = document.getElementById('address-results');

        addressInput.addEventListener('input', function() {
            clearTimeout(addressSearchTimeout);
            const query = this.value.trim();

            if (query.length < 3) {
                addressResultsEl.classList.remove('active');
                return;
            }

            addressResultsEl.innerHTML = '<div class="address-loading">Searching...</div>';
            addressResultsEl.classList.add('active');

            addressSearchTimeout = setTimeout(() => {
                searchAddress(query);
            }, 300);
        });

        async function searchAddress(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`,
                    { headers: { 'User-Agent': 'RouteView/1.0' } }
                );
                const results = await response.json();

                if (results.length === 0) {
                    addressResultsEl.innerHTML = '<div class="address-loading">No results found</div>';
                } else {
                    addressResultsEl.innerHTML = results.map((r, idx) => `
                        <div class="address-result-item" onclick="selectAddress(${idx})">
                            ${r.display_name}
                        </div>
                    `).join('');
                    window._addressResults = results;
                }
            } catch (err) {
                addressResultsEl.innerHTML = '<div class="address-loading">Search failed</div>';
            }
        }

        function selectAddress(idx) {
            const result = window._addressResults[idx];
            if (!result) return;

            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);

            document.getElementById('client-address').value = result.display_name;
            document.getElementById('client-lat').value = lat;
            document.getElementById('client-lng').value = lng;
            document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            addressResultsEl.classList.remove('active');

            // Center map and show temp marker
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);
            map.flyTo([lat, lng], 16);
        }

        // --- Pick on Map ---
        function togglePickOnMap() {
            if (isPickingOnMap) {
                cancelPickOnMap();
            } else {
                startPickOnMap();
            }
        }

        function startPickOnMap() {
            isPickingOnMap = true;
            map.getContainer().style.cursor = 'crosshair';

            // Hide modal, show overlay
            document.getElementById('modal').classList.remove('active');
            document.getElementById('pick-map-overlay').classList.add('active');
        }

        function cancelPickOnMap() {
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';

            // Hide overlay, show modal
            document.getElementById('pick-map-overlay').classList.remove('active');
            document.getElementById('modal').classList.add('active');
        }

        async function handleMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // Set coordinates
            document.getElementById('client-lat').value = lat;
            document.getElementById('client-lng').value = lng;
            document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            // Show temp marker
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);

            // Reverse geocode to get address
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                    { headers: { 'User-Agent': 'RouteView/1.0' } }
                );
                const result = await response.json();
                if (result.display_name) {
                    document.getElementById('client-address').value = result.display_name;
                }
            } catch (err) {
                // Ignore reverse geocode errors
            }

            // Hide overlay, show modal with filled data
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';
            document.getElementById('pick-map-overlay').classList.remove('active');
            document.getElementById('modal').classList.add('active');
        }

        // --- Visit Logs ---
        let currentClientId = null;
        let currentClientName = '';

        async function openLogs(clientId, clientName) {
            currentClientId = clientId;
            currentClientName = clientName;
            document.getElementById('logs-title').textContent = `Logs: ${clientName}`;
            document.getElementById('logs-search-input').value = '';
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            document.getElementById('logs-modal').classList.add('active');
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.remove('active');
            currentClientId = null;
        }

        async function loadLogs(search = '') {
            const url = `/api/clients/${currentClientId}/logs` + (search ? `?search=${encodeURIComponent(search)}` : '');
            const response = await fetch(url);
            const logs = await response.json();

            const listEl = document.getElementById('logs-list');
            if (logs.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No visits logged yet</div>';
            } else {
                listEl.innerHTML = logs.map(log => `
                    <div class="log-item">
                        <h4>${log.title}</h4>
                        ${log.notes ? `<p>${log.notes}</p>` : '<p style="font-style:italic;">No notes</p>'}
                        <div class="log-meta">${new Date(log.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        let searchLogsTimeout;
        function searchLogs() {
            clearTimeout(searchLogsTimeout);
            const query = document.getElementById('logs-search-input').value;
            searchLogsTimeout = setTimeout(() => loadLogs(query), 300);
        }

        async function checkIn() {
            const notes = document.getElementById('new-log-notes').value.trim();
            await fetch(`/api/clients/${currentClientId}/logs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes || null })
            });
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            // Refresh clients to update service status
            loadClientsWithStatus();
        }

        // Check in from execution panel
        async function checkInFromPanel() {
            if (!appState.activeRoute) return;

            const stop = appState.activeRoute.clients[appState.currentStopIndex];
            const client = stop.client;
            const notes = document.getElementById('exec-checkin-notes').value.trim();

            await fetch(`/api/clients/${client.id}/logs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes || null })
            });

            document.getElementById('exec-checkin-notes').value = '';

            // Mark stop as completed
            appState.completedStops.push(appState.currentStopIndex);

            // Move to next stop if available
            if (appState.currentStopIndex < appState.activeRoute.clients.length - 1) {
                appState.currentStopIndex++;
                updateExecutionPanel();
            } else {
                alert('Route complete! All stops visited.');
            }

            // Refresh clients to update service status
            loadClientsWithStatus();
        }

        // --- Routes ---
        let selectedClientIds = [];
        let editingRouteId = null;

        async function openRoutesModal() {
            await loadRoutes();
            document.getElementById('routes-modal').classList.add('active');
        }

        function closeRoutesModal() {
            document.getElementById('routes-modal').classList.remove('active');
        }

        async function loadRoutes() {
            const response = await fetch('/api/routes');
            const routes = await response.json();

            const listEl = document.getElementById('routes-list');
            if (routes.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No routes yet</div>';
            } else {
                listEl.innerHTML = routes.map(r => `
                    <div class="route-item" onclick="startRoute(${r.id})">
                        <h4>${r.name}</h4>
                        <small>${r.client_count} stops${r.description ? ' - ' + r.description : ''}</small>
                    </div>
                `).join('');
            }
        }

        function openCreateRouteModal() {
            editingRouteId = null;
            selectedClientIds = [];
            document.getElementById('route-form-title').textContent = 'Create Route';
            document.getElementById('route-name').value = '';
            document.getElementById('route-description').value = '';
            renderClientSelectList();
            closeRoutesModal();
            document.getElementById('route-form-modal').classList.add('active');
        }

        function closeRouteFormModal() {
            document.getElementById('route-form-modal').classList.remove('active');
        }

        function renderClientSelectList() {
            const listEl = document.getElementById('client-select-list');
            // Only show clients with coordinates for route selection
            const clientsWithCoords = allClients.filter(c => c.latitude && c.longitude);
            listEl.innerHTML = clientsWithCoords.map(client => {
                const idx = selectedClientIds.indexOf(client.id);
                const isSelected = idx !== -1;
                return `
                    <div class="client-select-item ${isSelected ? 'selected' : ''}" onclick="toggleClientSelect(${client.id})">
                        <div class="client-order">${isSelected ? idx + 1 : ''}</div>
                        <div>
                            <strong>${client.name}</strong><br>
                            <small style="color:#666;">${client.address || 'No address'}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleClientSelect(clientId) {
            const idx = selectedClientIds.indexOf(clientId);
            if (idx === -1) {
                selectedClientIds.push(clientId);
            } else {
                selectedClientIds.splice(idx, 1);
            }
            renderClientSelectList();
        }

        async function saveRoute() {
            const name = document.getElementById('route-name').value.trim();
            if (!name) {
                alert('Please enter a route name');
                return;
            }
            if (selectedClientIds.length === 0) {
                alert('Please select at least one client');
                return;
            }

            const data = {
                name,
                description: document.getElementById('route-description').value.trim() || null,
                client_ids: selectedClientIds
            };

            const url = editingRouteId ? `/api/routes/${editingRouteId}` : '/api/routes';
            const method = editingRouteId ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeRouteFormModal();
            openRoutesModal();
        }

        async function startRoute(routeId) {
            const response = await fetch(`/api/routes/${routeId}`);
            appState.activeRoute = await response.json();
            appState.currentStopIndex = 0;
            appState.completedStops = [];

            if (appState.activeRoute.clients.length === 0) {
                alert('This route has no clients');
                return;
            }

            closeRoutesModal();
            setMode('execution');
            updateExecutionPanel();
        }

        function updateExecutionPanel() {
            if (!appState.activeRoute) return;

            const route = appState.activeRoute;
            const currentIndex = appState.currentStopIndex;

            document.getElementById('exec-route-name').textContent = route.name;
            document.getElementById('exec-route-progress').textContent =
                `Stop ${currentIndex + 1} of ${route.clients.length}`;

            // Render stops list
            const stopsListEl = document.getElementById('route-stops-list');
            stopsListEl.innerHTML = route.clients.map((stop, idx) => {
                const client = stop.client;
                const isCompleted = appState.completedStops.includes(idx);
                const isCurrent = idx === currentIndex;

                return `
                    <div class="route-stop ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}"
                         onclick="goToStop(${idx})">
                        <div class="stop-number">${isCompleted ? '&#10003;' : idx + 1}</div>
                        <div class="client-item-info">
                            <div class="client-item-name">${client.name}</div>
                            <div class="client-item-address">${client.address || 'No address'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show actions for current stop
            const actionsEl = document.getElementById('exec-actions');
            actionsEl.style.display = 'flex';

            // Update directions link
            const currentStop = route.clients[currentIndex];
            const client = currentStop.client;
            document.getElementById('exec-directions-btn').href =
                `https://www.google.com/maps/dir/?api=1&destination=${client.latitude},${client.longitude}`;

            // Pan to current stop
            map.flyTo([client.latitude, client.longitude], 16);
            setTimeout(() => clientMarkers[client.id]?.openPopup(), 500);
        }

        function goToStop(idx) {
            appState.currentStopIndex = idx;
            updateExecutionPanel();
        }

        function exitRouteExecution() {
            appState.activeRoute = null;
            appState.currentStopIndex = 0;
            appState.completedStops = [];
            document.getElementById('exec-actions').style.display = 'none';
            document.getElementById('exec-route-name').textContent = 'No route selected';
            document.getElementById('exec-route-progress').textContent = '';
            document.getElementById('route-stops-list').innerHTML = '<div class="empty-state">Select a route to start</div>';
            setMode('planning');
        }

        // --- Bidirectional Map-List Sync ---
        let mapMoveTimeout = null;
        let mapSyncInitialized = false;

        function setupMapSync() {
            // Only set up once
            if (mapSyncInitialized) return;
            mapSyncInitialized = true;

            map.on('moveend', handleMapMove);
            map.on('zoomend', handleMapMove);
        }

        function handleMapMove() {
            // Skip if in execution mode or if user is searching
            if (appState.mode === 'execution') return;
            const searchQuery = document.getElementById('client-search')?.value?.trim();
            if (searchQuery && searchQuery.length > 0) return;

            // Debounce to avoid excessive updates
            clearTimeout(mapMoveTimeout);
            mapMoveTimeout = setTimeout(() => {
                filterClientsByViewport();
            }, 150);
        }

        function filterClientsByViewport() {
            const bounds = map.getBounds();

            // Filter clients to those visible in current viewport
            appState.filteredClients = appState.clientsWithStatus.filter(client => {
                if (!client.latitude || !client.longitude) return false;
                return bounds.contains([client.latitude, client.longitude]);
            });

            // Re-render the client list
            renderClientList();

            // Update the count to show filtered/total
            const countEl = document.getElementById('count');
            const showAllLink = document.getElementById('show-all-link');

            if (countEl) {
                const total = appState.clientsWithStatus.length;
                const visible = appState.filteredClients.length;
                countEl.textContent = visible === total ? total : `${visible} of ${total}`;
            }

            // Show/hide "Show all" link
            if (showAllLink) {
                const total = appState.clientsWithStatus.length;
                const visible = appState.filteredClients.length;
                showAllLink.style.display = visible < total ? 'inline' : 'none';
            }
        }

        function showAllClients() {
            // Clear search input
            const searchInput = document.getElementById('client-search');
            if (searchInput) {
                searchInput.value = '';
            }

            appState.filteredClients = [...appState.clientsWithStatus];
            renderClientList();

            // Fit map to all clients
            const clientsWithCoords = appState.clientsWithStatus.filter(c => c.latitude && c.longitude);
            if (clientsWithCoords.length > 0) {
                const bounds = L.latLngBounds(clientsWithCoords.map(c => [c.latitude, c.longitude]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Update count
            const countEl = document.getElementById('count');
            if (countEl) {
                countEl.textContent = appState.clientsWithStatus.length;
            }

            // Hide "Show all" link
            const showAllLink = document.getElementById('show-all-link');
            if (showAllLink) {
                showAllLink.style.display = 'none';
            }
        }
    </script>
</body>
</html>
