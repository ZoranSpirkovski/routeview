<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteView - Client Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 18px; font-weight: 600; }

        #map { height: calc(100vh - 50px); width: 100%; margin-top: 50px; }

        .controls {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }

        .controls h2 { margin-bottom: 10px; font-size: 18px; }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 8px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }

        .search-box {
            margin-bottom: 10px;
        }
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result-item:hover { background: #f3f4f6; }
        .search-result-item:last-child { border-bottom: none; }

        /* Address autocomplete dropdown */
        .address-autocomplete {
            position: relative;
        }
        .address-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }
        .address-results.active { display: block; }
        .address-result-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        .address-result-item:hover { background: #f3f4f6; }
        .address-result-item:last-child { border-bottom: none; }
        .address-loading {
            padding: 10px 12px;
            color: #666;
            font-style: italic;
        }

        /* Pick on map button states */
        .btn-pick-map { background: #6366f1; }
        .btn-pick-map:hover { background: #4f46e5; }
        .btn-pick-map.active { background: #dc2626; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .coords-display {
            color: #666;
            font-size: 13px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
        }

        .client-count {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 { margin-bottom: 16px; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .modal-buttons .btn { flex: 1; margin-bottom: 0; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }

        .popup-content h4 { margin-bottom: 8px; }
        .popup-content p { color: #666; font-size: 13px; margin-bottom: 4px; }
        .popup-buttons { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .popup-buttons button, .popup-buttons a { padding: 4px 10px; font-size: 12px; }

        /* Logs Modal */
        .logs-modal .modal-content { max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logs-header h3 { margin: 0; }
        .logs-search { margin-bottom: 12px; }
        .logs-search input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .logs-list { flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid #eee; border-radius: 8px; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; }
        .log-item:last-child { border-bottom: none; }
        .log-item h4 { font-size: 14px; margin-bottom: 4px; color: #1e293b; }
        .log-item p { font-size: 13px; color: #666; margin: 0; }
        .log-item .log-meta { font-size: 11px; color: #999; margin-top: 4px; }
        .log-empty { padding: 20px; text-align: center; color: #999; }
        .btn-orange { background: #f97316; }
        .btn-orange:hover { background: #ea580c; }
        .add-log-form { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        .add-log-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; margin-bottom: 8px; }

        /* Routes */
        .btn-purple { background: #7c3aed; }
        .btn-purple:hover { background: #6d28d9; }
        .route-list { margin-top: 10px; }
        .route-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .route-item:hover { background: #f9fafb; }
        .route-item h4 { font-size: 14px; margin-bottom: 2px; }
        .route-item small { color: #666; }

        /* Route Navigation Panel */
        .route-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 1000;
            display: none;
            min-width: 320px;
            max-width: 90%;
        }
        .route-nav.active { display: block; }
        .route-nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .route-nav-header h4 { margin: 0; font-size: 16px; }
        .route-nav-progress { font-size: 13px; color: #666; margin-bottom: 10px; }
        .route-nav-location { font-weight: 600; margin-bottom: 8px; }
        .route-nav-address { font-size: 13px; color: #666; margin-bottom: 12px; }
        .route-nav-buttons { display: flex; gap: 8px; }
        .route-nav-buttons .btn { flex: 1; margin: 0; padding: 12px; }

        /* Client selection for routes */
        .client-select-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-bottom: 12px; }
        .client-select-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .client-select-item:hover { background: #f9fafb; }
        .client-select-item.selected { background: #eff6ff; }
        .client-select-item:last-child { border-bottom: none; }
        .client-order { width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .client-select-item.selected .client-order { background: #2563eb; color: white; }

        /* Mobile Controls Toggle */
        .controls-toggle {
            display: none;
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .header { padding: 0 12px; }
            .header h1 { font-size: 16px; }

            .controls {
                position: fixed;
                top: 50px;
                right: 0;
                left: 0;
                max-width: none;
                border-radius: 0;
                padding: 12px;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
            }
            .controls.open { transform: translateY(0); }
            .controls h2 { display: none; }

            .controls-toggle { display: block; }
            .controls-toggle.open { display: none; }

            .btn {
                padding: 14px 16px;
                font-size: 16px;
            }

            .search-box input {
                padding: 12px;
                font-size: 16px;
            }

            /* Full-screen modals on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 16px;
                display: flex;
                flex-direction: column;
            }

            .logs-modal .modal-content,
            .modal-content[style*="max-width:450px"] {
                max-width: 100%;
                max-height: 100%;
            }

            .logs-list { max-height: none; flex: 1; }
            .client-select-list { max-height: none; flex: 1; }

            .form-group input,
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }

            /* Route navigation - full width at bottom */
            .route-nav {
                left: 0;
                right: 0;
                bottom: 0;
                transform: none;
                border-radius: 16px 16px 0 0;
                min-width: auto;
                max-width: none;
                padding: 16px;
            }

            .route-nav-buttons .btn {
                padding: 14px;
                font-size: 15px;
            }

            /* Bigger popup buttons */
            .popup-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .popup-buttons button,
            .popup-buttons a {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                text-align: center;
            }

            /* Filter results */
            .search-results {
                position: fixed;
                left: 12px;
                right: 12px;
                top: auto;
                max-height: 50vh;
            }

            /* Address autocomplete on mobile */
            .address-results {
                position: fixed;
                left: 16px;
                right: 16px;
                top: auto;
                max-height: 40vh;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 601px) and (max-width: 900px) {
            .controls { max-width: 280px; }
            .modal-content { max-width: 90%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>RouteView</h1>
    </header>
    <div id="map"></div>

    <button id="controls-toggle" class="controls-toggle" onclick="toggleControls()">Menu</button>

    <div id="controls" class="controls">
        <h2>RouteView</h2>
        <div class="search-box">
            <input type="text" id="client-filter" placeholder="Filter clients..." oninput="filterClients()">
        </div>
        <div id="filter-results" class="search-results" style="display:none;"></div>
        <button class="btn" onclick="startAddClient()">+ Add Client</button>
        <button class="btn btn-purple" onclick="openRoutesModal()">Routes</button>
        <p class="client-count"><span id="count">0</span> clients</p>
    </div>

    <!-- Route Navigation Panel -->
    <div id="route-nav" class="route-nav">
        <div class="route-nav-header">
            <h4 id="route-nav-title">Route Name</h4>
            <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="exitRoute()">Exit</button>
        </div>
        <div class="route-nav-progress">Stop <span id="route-current">1</span> of <span id="route-total">5</span></div>
        <div id="route-nav-client" class="route-nav-location">Client Name</div>
        <div id="route-nav-address" class="route-nav-address">Address here</div>
        <div class="route-nav-buttons">
            <button class="btn btn-secondary" onclick="prevStop()">Previous</button>
            <a id="route-directions-btn" href="#" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
            <button class="btn" onclick="nextStop()">Next</button>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Client</h3>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <input type="hidden" id="client-lat">
                <input type="hidden" id="client-lng">

                <div class="form-group">
                    <label>Client/Business Name *</label>
                    <input type="text" id="client-name" required placeholder="e.g., ABC Company">
                </div>
                <div class="form-group address-autocomplete">
                    <label>Address *</label>
                    <input type="text" id="client-address" required placeholder="Start typing an address..." autocomplete="off">
                    <div id="address-results" class="address-results"></div>
                </div>
                <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" id="client-contact-name" placeholder="e.g., John Smith">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="client-phone" placeholder="e.g., +1 555-1234">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="client-email" placeholder="e.g., john@example.com">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="client-notes" placeholder="Any additional notes..."></textarea>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <div id="coords-display" class="coords-display">Not set - enter address or pick on map</div>
                </div>

                <button type="button" id="pick-map-btn" class="btn btn-pick-map" onclick="togglePickOnMap()">Pick on Map</button>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Visit Logs Modal -->
    <div id="logs-modal" class="modal logs-modal">
        <div class="modal-content">
            <div class="logs-header">
                <h3 id="logs-title">Visit Logs</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeLogsModal()">Close</button>
            </div>
            <div class="logs-search">
                <input type="text" id="logs-search-input" placeholder="Search logs..." oninput="searchLogs()">
            </div>
            <div id="logs-list" class="logs-list">
                <div class="log-empty">No visits logged yet</div>
            </div>
            <div class="add-log-form">
                <textarea id="new-log-notes" placeholder="Add notes about this visit (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkIn()">Check In</button>
            </div>
        </div>
    </div>

    <!-- Routes Modal -->
    <div id="routes-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="logs-header">
                <h3>Routes</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeRoutesModal()">Close</button>
            </div>
            <button class="btn" onclick="openCreateRouteModal()">+ Create New Route</button>
            <div id="routes-list" class="route-list">
                <div class="log-empty">No routes yet</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Route Modal -->
    <div id="route-form-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <h3 id="route-form-title">Create Route</h3>
            <div class="form-group">
                <label>Route Name *</label>
                <input type="text" id="route-name" placeholder="e.g., Monday Route">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="route-description" placeholder="e.g., Downtown clients">
            </div>
            <div class="form-group">
                <label>Select Clients (click in order)</label>
                <div id="client-select-list" class="client-select-list"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRouteFormModal()">Cancel</button>
                <button class="btn" onclick="saveRoute()">Save Route</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map (centered on Europe - adjust as needed)
        const map = L.map('map').setView([41.9981, 21.4254], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let clientMarkers = {};
        let tempMarker = null;
        let isPickingOnMap = false;
        let allClients = [];
        let addressSearchTimeout = null;

        // Mobile controls toggle
        function toggleControls() {
            const controls = document.getElementById('controls');
            const toggle = document.getElementById('controls-toggle');
            controls.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        // Close controls when clicking on map (mobile) and handle pick on map
        map.on('click', function(e) {
            if (window.innerWidth <= 600) {
                document.getElementById('controls').classList.remove('open');
                document.getElementById('controls-toggle').classList.remove('open');
            }

            // Handle pick on map mode
            if (isPickingOnMap) {
                handleMapClick(e);
            }
        });

        // Load clients on start
        loadClients();

        // Filter existing clients
        function filterClients() {
            const query = document.getElementById('client-filter').value.toLowerCase().trim();
            const resultsEl = document.getElementById('filter-results');

            if (query.length < 2) {
                resultsEl.style.display = 'none';
                return;
            }

            const matches = allClients.filter(client =>
                client.name.toLowerCase().includes(query) ||
                (client.address && client.address.toLowerCase().includes(query)) ||
                (client.contact_name && client.contact_name.toLowerCase().includes(query))
            ).slice(0, 5);

            if (matches.length === 0) {
                resultsEl.innerHTML = '<div class="search-result-item">No matches</div>';
            } else {
                resultsEl.innerHTML = matches.map(client => `
                    <div class="search-result-item" onclick="goToClient(${client.id})">
                        <strong>${client.name}</strong><br>
                        <small style="color:#666;">${client.address || 'No address'}</small>
                    </div>
                `).join('');
            }
            resultsEl.style.display = 'block';
        }

        function goToClient(id) {
            document.getElementById('filter-results').style.display = 'none';
            document.getElementById('client-filter').value = '';
            const client = allClients.find(c => c.id === id);
            if (client && client.latitude && client.longitude) {
                map.flyTo([client.latitude, client.longitude], 16);
                setTimeout(() => clientMarkers[id]?.openPopup(), 500);
            }
        }

        // Close filter results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.controls')) {
                document.getElementById('filter-results').style.display = 'none';
            }
            // Close address results when clicking outside
            if (!e.target.closest('.address-autocomplete')) {
                document.getElementById('address-results').classList.remove('active');
            }
        });

        async function loadClients() {
            const response = await fetch('/api/clients');
            const clients = await response.json();
            allClients = clients;

            // Clear existing markers
            Object.values(clientMarkers).forEach(m => map.removeLayer(m));
            clientMarkers = {};

            // Only add markers for clients with coordinates
            clients.filter(c => c.latitude && c.longitude).forEach(client => {
                addMarker(client);
            });

            document.getElementById('count').textContent = clients.length;

            // Fit bounds if there are clients with coordinates
            const clientsWithCoords = clients.filter(c => c.latitude && c.longitude);
            if (clientsWithCoords.length > 0) {
                const bounds = L.latLngBounds(clientsWithCoords.map(c => [c.latitude, c.longitude]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function addMarker(client) {
            const marker = L.marker([client.latitude, client.longitude])
                .addTo(map)
                .bindPopup(createPopupContent(client));
            clientMarkers[client.id] = marker;
        }

        function createPopupContent(client) {
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${client.latitude},${client.longitude}`;
            return `
                <div class="popup-content">
                    <h4>${client.name}</h4>
                    ${client.address ? `<p style="margin-bottom:4px;">${client.address}</p>` : ''}
                    ${client.contact_name ? `<p style="margin-bottom:2px;"><strong>Contact:</strong> ${client.contact_name}</p>` : ''}
                    ${client.contact_phone ? `<p style="margin-bottom:2px;"><strong>Phone:</strong> <a href="tel:${client.contact_phone}">${client.contact_phone}</a></p>` : ''}
                    ${client.contact_email ? `<p style="margin-bottom:2px;"><strong>Email:</strong> <a href="mailto:${client.contact_email}">${client.contact_email}</a></p>` : ''}
                    ${client.notes ? `<p style="margin-top:6px;font-style:italic;color:#666;">${client.notes}</p>` : ''}
                    <div class="popup-buttons">
                        <a href="${directionsUrl}" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
                        <button class="btn btn-orange" onclick="openLogs(${client.id}, '${client.name.replace(/'/g, "\\'")}')">Logs</button>
                        <button class="btn" onclick="editClient(${client.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteClient(${client.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        // Open Add Client modal directly (no alert)
        function startAddClient() {
            document.getElementById('modal-title').textContent = 'Add Client';
            document.getElementById('client-id').value = '';
            document.getElementById('client-lat').value = '';
            document.getElementById('client-lng').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-address').value = '';
            document.getElementById('client-contact-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-notes').value = '';
            document.getElementById('coords-display').textContent = 'Not set - enter address or pick on map';
            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            openModal();
        }

        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            cancelPickOnMap();
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        async function editClient(id) {
            const response = await fetch(`/api/clients/${id}`);
            const client = await response.json();

            document.getElementById('modal-title').textContent = 'Edit Client';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-lat').value = client.latitude || '';
            document.getElementById('client-lng').value = client.longitude || '';
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-contact-name').value = client.contact_name || '';
            document.getElementById('client-phone').value = client.contact_phone || '';
            document.getElementById('client-email').value = client.contact_email || '';
            document.getElementById('client-notes').value = client.notes || '';

            if (client.latitude && client.longitude) {
                document.getElementById('coords-display').textContent =
                    `${client.latitude.toFixed(6)}, ${client.longitude.toFixed(6)}`;
            } else {
                document.getElementById('coords-display').textContent = 'Not set - enter address or pick on map';
            }

            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            openModal();
        }

        async function deleteClient(id) {
            if (!confirm('Delete this client?')) return;

            await fetch(`/api/clients/${id}`, { method: 'DELETE' });
            loadClients();
        }

        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('client-id').value;
            const lat = document.getElementById('client-lat').value;
            const lng = document.getElementById('client-lng').value;

            if (!lat || !lng) {
                alert('Please set a location by entering an address or picking on the map');
                return;
            }

            const data = {
                name: document.getElementById('client-name').value,
                address: document.getElementById('client-address').value || null,
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                contact_name: document.getElementById('client-contact-name').value || null,
                contact_phone: document.getElementById('client-phone').value || null,
                contact_email: document.getElementById('client-email').value || null,
                notes: document.getElementById('client-notes').value || null
            };

            const url = id ? `/api/clients/${id}` : '/api/clients';
            const method = id ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeModal();
            loadClients();
        });

        // --- Address Autocomplete with Nominatim ---
        const addressInput = document.getElementById('client-address');
        const addressResultsEl = document.getElementById('address-results');

        addressInput.addEventListener('input', function() {
            clearTimeout(addressSearchTimeout);
            const query = this.value.trim();

            if (query.length < 3) {
                addressResultsEl.classList.remove('active');
                return;
            }

            addressResultsEl.innerHTML = '<div class="address-loading">Searching...</div>';
            addressResultsEl.classList.add('active');

            addressSearchTimeout = setTimeout(() => {
                searchAddress(query);
            }, 300);
        });

        async function searchAddress(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`,
                    { headers: { 'User-Agent': 'RouteView/1.0' } }
                );
                const results = await response.json();

                if (results.length === 0) {
                    addressResultsEl.innerHTML = '<div class="address-loading">No results found</div>';
                } else {
                    addressResultsEl.innerHTML = results.map((r, idx) => `
                        <div class="address-result-item" onclick="selectAddress(${idx})">
                            ${r.display_name}
                        </div>
                    `).join('');
                    window._addressResults = results;
                }
            } catch (err) {
                addressResultsEl.innerHTML = '<div class="address-loading">Search failed</div>';
            }
        }

        function selectAddress(idx) {
            const result = window._addressResults[idx];
            if (!result) return;

            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);

            document.getElementById('client-address').value = result.display_name;
            document.getElementById('client-lat').value = lat;
            document.getElementById('client-lng').value = lng;
            document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            addressResultsEl.classList.remove('active');

            // Center map and show temp marker
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);
            map.flyTo([lat, lng], 16);
        }

        // --- Pick on Map ---
        function togglePickOnMap() {
            if (isPickingOnMap) {
                cancelPickOnMap();
            } else {
                startPickOnMap();
            }
        }

        function startPickOnMap() {
            isPickingOnMap = true;
            map.getContainer().style.cursor = 'crosshair';
            document.getElementById('pick-map-btn').textContent = 'Click map now...';
            document.getElementById('pick-map-btn').classList.add('active');

            // Minimize modal on mobile to see map
            if (window.innerWidth <= 600) {
                document.getElementById('modal').style.display = 'none';
            }
        }

        function cancelPickOnMap() {
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';
            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            // Restore modal on mobile
            if (window.innerWidth <= 600) {
                document.getElementById('modal').style.display = '';
            }
        }

        async function handleMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // Set coordinates
            document.getElementById('client-lat').value = lat;
            document.getElementById('client-lng').value = lng;
            document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            // Show temp marker
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);

            // Reverse geocode to get address
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                    { headers: { 'User-Agent': 'RouteView/1.0' } }
                );
                const result = await response.json();
                if (result.display_name) {
                    document.getElementById('client-address').value = result.display_name;
                }
            } catch (err) {
                // Ignore reverse geocode errors
            }

            cancelPickOnMap();

            // Restore modal on mobile
            if (window.innerWidth <= 600) {
                document.getElementById('modal').style.display = '';
                document.getElementById('modal').classList.add('active');
            }
        }

        // --- Visit Logs ---
        let currentClientId = null;
        let currentClientName = '';

        async function openLogs(clientId, clientName) {
            currentClientId = clientId;
            currentClientName = clientName;
            document.getElementById('logs-title').textContent = `Logs: ${clientName}`;
            document.getElementById('logs-search-input').value = '';
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            document.getElementById('logs-modal').classList.add('active');
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.remove('active');
            currentClientId = null;
        }

        async function loadLogs(search = '') {
            const url = `/api/clients/${currentClientId}/logs` + (search ? `?search=${encodeURIComponent(search)}` : '');
            const response = await fetch(url);
            const logs = await response.json();

            const listEl = document.getElementById('logs-list');
            if (logs.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No visits logged yet</div>';
            } else {
                listEl.innerHTML = logs.map(log => `
                    <div class="log-item">
                        <h4>${log.title}</h4>
                        ${log.notes ? `<p>${log.notes}</p>` : '<p style="font-style:italic;">No notes</p>'}
                        <div class="log-meta">${new Date(log.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        let searchLogsTimeout;
        function searchLogs() {
            clearTimeout(searchLogsTimeout);
            const query = document.getElementById('logs-search-input').value;
            searchLogsTimeout = setTimeout(() => loadLogs(query), 300);
        }

        async function checkIn() {
            const notes = document.getElementById('new-log-notes').value.trim();
            await fetch(`/api/clients/${currentClientId}/logs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes || null })
            });
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
        }

        // --- Routes ---
        let selectedClientIds = [];
        let editingRouteId = null;
        let activeRoute = null;
        let currentStopIndex = 0;

        async function openRoutesModal() {
            await loadRoutes();
            document.getElementById('routes-modal').classList.add('active');
        }

        function closeRoutesModal() {
            document.getElementById('routes-modal').classList.remove('active');
        }

        async function loadRoutes() {
            const response = await fetch('/api/routes');
            const routes = await response.json();

            const listEl = document.getElementById('routes-list');
            if (routes.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No routes yet</div>';
            } else {
                listEl.innerHTML = routes.map(r => `
                    <div class="route-item" onclick="startRoute(${r.id})">
                        <h4>${r.name}</h4>
                        <small>${r.client_count} stops${r.description ? ' • ' + r.description : ''}</small>
                    </div>
                `).join('');
            }
        }

        function openCreateRouteModal() {
            editingRouteId = null;
            selectedClientIds = [];
            document.getElementById('route-form-title').textContent = 'Create Route';
            document.getElementById('route-name').value = '';
            document.getElementById('route-description').value = '';
            renderClientSelectList();
            closeRoutesModal();
            document.getElementById('route-form-modal').classList.add('active');
        }

        function closeRouteFormModal() {
            document.getElementById('route-form-modal').classList.remove('active');
        }

        function renderClientSelectList() {
            const listEl = document.getElementById('client-select-list');
            // Only show clients with coordinates for route selection
            const clientsWithCoords = allClients.filter(c => c.latitude && c.longitude);
            listEl.innerHTML = clientsWithCoords.map(client => {
                const idx = selectedClientIds.indexOf(client.id);
                const isSelected = idx !== -1;
                return `
                    <div class="client-select-item ${isSelected ? 'selected' : ''}" onclick="toggleClientSelect(${client.id})">
                        <div class="client-order">${isSelected ? idx + 1 : ''}</div>
                        <div>
                            <strong>${client.name}</strong><br>
                            <small style="color:#666;">${client.address || 'No address'}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleClientSelect(clientId) {
            const idx = selectedClientIds.indexOf(clientId);
            if (idx === -1) {
                selectedClientIds.push(clientId);
            } else {
                selectedClientIds.splice(idx, 1);
            }
            renderClientSelectList();
        }

        async function saveRoute() {
            const name = document.getElementById('route-name').value.trim();
            if (!name) {
                alert('Please enter a route name');
                return;
            }
            if (selectedClientIds.length === 0) {
                alert('Please select at least one client');
                return;
            }

            const data = {
                name,
                description: document.getElementById('route-description').value.trim() || null,
                client_ids: selectedClientIds
            };

            const url = editingRouteId ? `/api/routes/${editingRouteId}` : '/api/routes';
            const method = editingRouteId ? 'PUT' : 'POST';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            closeRouteFormModal();
            openRoutesModal();
        }

        async function startRoute(routeId) {
            const response = await fetch(`/api/routes/${routeId}`);
            activeRoute = await response.json();
            currentStopIndex = 0;

            if (activeRoute.clients.length === 0) {
                alert('This route has no clients');
                return;
            }

            closeRoutesModal();
            updateRouteNav();
            document.getElementById('route-nav').classList.add('active');
        }

        function updateRouteNav() {
            const stop = activeRoute.clients[currentStopIndex];
            const client = stop.client;

            document.getElementById('route-nav-title').textContent = activeRoute.name;
            document.getElementById('route-current').textContent = currentStopIndex + 1;
            document.getElementById('route-total').textContent = activeRoute.clients.length;
            document.getElementById('route-nav-client').textContent = client.name;
            document.getElementById('route-nav-address').textContent = client.address || 'No address';
            document.getElementById('route-directions-btn').href =
                `https://www.google.com/maps/dir/?api=1&destination=${client.latitude},${client.longitude}`;

            map.flyTo([client.latitude, client.longitude], 16);
            setTimeout(() => clientMarkers[client.id]?.openPopup(), 500);
        }

        function prevStop() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                updateRouteNav();
            }
        }

        function nextStop() {
            if (currentStopIndex < activeRoute.clients.length - 1) {
                currentStopIndex++;
                updateRouteNav();
            } else {
                alert('Route complete!');
            }
        }

        function exitRoute() {
            document.getElementById('route-nav').classList.remove('active');
            activeRoute = null;
            currentStopIndex = 0;
        }
    </script>
</body>
</html>
