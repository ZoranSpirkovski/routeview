<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteView - Client Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 18px; font-weight: 600; }

        #map {
            height: calc(100vh - 50px);
            margin-top: 50px;
            margin-left: 320px;
            width: calc(100% - 320px);
        }

        /* Left Panel */
        .left-panel {
            position: fixed;
            top: 50px;
            left: 0;
            bottom: 0;
            width: 320px;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .panel-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .mode-toggle {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }

        .mode-btn:hover { background: rgba(255,255,255,0.5); }
        .mode-btn.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: #2563eb;
        }

        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-search {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .panel-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .client-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
        }

        .client-item:hover { background: #f9fafb; }
        .client-item.highlighted {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .client-item-info { flex: 1; min-width: 0; }
        .client-item-name { font-weight: 500; margin-bottom: 2px; }
        .client-item-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .client-item-last { font-size: 11px; color: #999; margin-top: 2px; }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-green { background: #22c55e; }
        .status-orange { background: #f97316; }
        .status-red { background: #ef4444; }
        .status-never { background: #9ca3af; }

        .panel-footer {
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Execution mode styles */
        .exec-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .exec-header h4 { margin: 0 0 4px 0; }
        .exec-header p { margin: 0; font-size: 13px; color: #666; }

        .exec-actions {
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .exec-actions textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 60px;
            resize: vertical;
        }

        /* Route stop items */
        .route-stop {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #eee;
        }
        .route-stop:hover { background: #f9fafb; }
        .route-stop.current { background: #eff6ff; border-color: #3b82f6; }
        .route-stop.completed { opacity: 0.6; }
        .stop-number {
            width: 28px;
            height: 28px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
        }
        .route-stop.current .stop-number { background: #2563eb; color: white; }
        .route-stop.completed .stop-number { background: #22c55e; color: white; }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #999;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 0;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-purple { background: #7c3aed; }
        .btn-purple:hover { background: #6d28d9; }
        .btn-orange { background: #f97316; }
        .btn-orange:hover { background: #ea580c; }

        /* Address autocomplete dropdown */
        .address-autocomplete {
            position: relative;
        }
        .address-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }
        .address-results.active { display: block; }
        .address-result-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        .address-result-item:hover { background: #f3f4f6; }
        .address-result-item:last-child { border-bottom: none; }
        .address-loading {
            padding: 10px 12px;
            color: #666;
            font-style: italic;
        }

        /* Pick on map button states */
        .btn-pick-map { background: #6366f1; }
        .btn-pick-map:hover { background: #4f46e5; }

        /* Floating cancel button when picking on map */
        .pick-map-overlay {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
        }
        .pick-map-overlay.active { display: block; }
        .pick-map-overlay p { margin-bottom: 12px; font-weight: 500; }
        .pick-map-overlay .btn { width: auto; margin: 0; }

        .coords-display {
            color: #666;
            font-size: 13px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 { margin-bottom: 16px; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .modal-buttons .btn { flex: 1; margin-bottom: 0; }

        .popup-content h4 { margin-bottom: 8px; }
        .popup-content p { color: #666; font-size: 13px; margin-bottom: 4px; }
        .popup-buttons { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .popup-buttons button, .popup-buttons a { padding: 4px 10px; font-size: 12px; }

        /* Logs Modal */
        .logs-modal .modal-content { max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logs-header h3 { margin: 0; }
        .logs-search { margin-bottom: 12px; }
        .logs-search input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .logs-list { flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid #eee; border-radius: 8px; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; }
        .log-item:last-child { border-bottom: none; }
        .log-item h4 { font-size: 14px; margin-bottom: 4px; color: #1e293b; }
        .log-item p { font-size: 13px; color: #666; margin: 0; }
        .log-item .log-meta { font-size: 11px; color: #999; margin-top: 4px; }
        .log-empty { padding: 20px; text-align: center; color: #999; }
        .add-log-form { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        .add-log-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; margin-bottom: 8px; }

        /* Routes */
        .route-list { margin-top: 10px; }
        .route-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .route-item:hover { background: #f9fafb; }
        .route-item h4 { font-size: 14px; margin-bottom: 2px; }
        .route-item small { color: #666; }

        /* Client selection for routes */
        .client-select-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-bottom: 12px; }
        .client-select-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .client-select-item:hover { background: #f9fafb; }
        .client-select-item.selected { background: #eff6ff; }
        .client-select-item:last-child { border-bottom: none; }
        .client-order { width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .client-select-item.selected .client-order { background: #2563eb; color: white; }

        /* Mobile toggle button */
        .panel-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            background: #2563eb;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* Mobile: panel slides overlay */
        @media (max-width: 768px) {
            .left-panel {
                width: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .left-panel.open { transform: translateX(0); }
            #map { margin-left: 0; width: 100%; }

            .panel-toggle { display: block; }

            .header { padding: 0 12px; }
            .header h1 { font-size: 16px; }

            .btn {
                padding: 14px 16px;
                font-size: 16px;
            }

            /* Full-screen modals on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 16px;
                display: flex;
                flex-direction: column;
            }

            .logs-modal .modal-content,
            .modal-content[style*="max-width:450px"] {
                max-width: 100%;
                max-height: 100%;
            }

            .logs-list { max-height: none; flex: 1; }
            .client-select-list { max-height: none; flex: 1; }

            .form-group input,
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }

            /* Bigger popup buttons */
            .popup-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .popup-buttons button,
            .popup-buttons a {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                text-align: center;
            }

            /* Address autocomplete on mobile */
            .address-results {
                position: fixed;
                left: 16px;
                right: 16px;
                top: auto;
                max-height: 40vh;
            }
        }

        @media (min-width: 769px) {
            .panel-toggle { display: none; }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 900px) {
            .modal-content { max-width: 90%; }
        }

        /* Schedule Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 12px;
        }
        .calendar-header {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: #666;
            padding: 8px 4px;
        }
        .calendar-day {
            min-height: 60px;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 4px;
            font-size: 11px;
            cursor: pointer;
            position: relative;
        }
        .calendar-day:hover { background: #f9fafb; }
        .calendar-day.other-month { background: #f9fafb; color: #999; }
        .calendar-day.today { border-color: #2563eb; border-width: 2px; }
        .calendar-day.selected { background: #eff6ff; border-color: #3b82f6; }
        .day-number {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .day-assignments {
            font-size: 10px;
            overflow: hidden;
        }
        .day-assignment {
            background: #dbeafe;
            border-radius: 2px;
            padding: 2px 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .day-assignment.completed { background: #dcfce7; }
        .day-assignment.in_progress { background: #fef3c7; }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }
        .calendar-nav h4 { margin: 0; }
        .calendar-nav button {
            background: transparent;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .calendar-nav button:hover { background: #f3f4f6; }

        /* Template list styles */
        .template-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .template-item:hover { background: #f9fafb; }
        .template-info h4 { font-size: 14px; margin-bottom: 4px; }
        .template-info small { color: #666; }
        .template-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .template-actions button { padding: 4px 8px; font-size: 12px; width: auto; }

        .schedule-days-tags {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .schedule-day-tag {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Assignment form styles */
        .assignment-form {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 12px;
            background: #f9fafb;
        }
        .assignment-form h5 { margin: 0 0 12px 0; }
        .selected-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .selected-date-tag {
            background: #dbeafe;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .selected-date-tag button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>RouteView</h1>
        <div id="user-info" style="margin-left:auto;display:none;align-items:center;gap:12px;">
            <span id="user-name" style="font-size:14px;"></span>
            <button onclick="logout()" style="background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">Logout</button>
        </div>
    </header>
    <div id="map"></div>

    <!-- Left Panel -->
    <div id="left-panel" class="left-panel">
        <!-- Panel Header with Mode Toggle -->
        <div class="panel-header">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="planning" onclick="setMode('planning')">Planning</button>
                <button class="mode-btn" data-mode="execution" onclick="setMode('execution')">Execution</button>
            </div>
        </div>

        <!-- Planning Mode Content -->
        <div id="planning-content" class="panel-content">
            <div class="panel-search">
                <input type="text" id="client-search" placeholder="Search clients..." oninput="filterClientList()">
            </div>
            <div style="padding: 4px 12px; font-size: 12px; color: #666; display: flex; justify-content: space-between; align-items: center;">
                <span>Showing <span id="count">0</span> clients</span>
                <a href="#" id="show-all-link" style="color: #2563eb; text-decoration: none; display: none;" onclick="showAllClients(); return false;">Show all</a>
            </div>
            <div id="client-list" class="client-list">
                <!-- Client items rendered here -->
            </div>
            <div class="panel-footer">
                <button class="btn" onclick="startAddClient()">+ Add Client</button>
                <button class="btn btn-purple" onclick="openRoutesModal()">Manage Routes</button>
                <button class="btn btn-orange" data-admin-only style="display:none;" onclick="openScheduleModal()">Schedule</button>
                <button class="btn btn-secondary" data-admin-only style="display:none;" onclick="openUsersModal()">Manage Users</button>
            </div>
        </div>

        <!-- Execution Mode Content -->
        <div id="execution-content" class="panel-content" style="display:none;">
            <div class="exec-header">
                <h4 id="exec-route-name">No route selected</h4>
                <p id="exec-route-progress"></p>
            </div>
            <div id="route-stops-list" class="client-list">
                <!-- Route stops rendered here -->
            </div>
            <div class="exec-actions" id="exec-actions" style="display:none;">
                <textarea id="exec-checkin-notes" placeholder="Check-in notes (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkInFromPanel()">Check In</button>
                <a id="exec-directions-btn" href="#" target="_blank" class="btn btn-purple" style="text-decoration:none;text-align:center;">Get Directions</a>
            </div>
            <div class="panel-footer">
                <button class="btn btn-orange" onclick="openMyAssignmentsModal()">My Assignments</button>
                <button class="btn btn-secondary" onclick="exitRouteExecution()">Exit Route</button>
            </div>
        </div>
    </div>

    <!-- Mobile Panel Toggle -->
    <button class="panel-toggle" onclick="togglePanel()">Menu</button>

    <!-- Add/Edit Client Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Client</h3>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <input type="hidden" id="client-lat">
                <input type="hidden" id="client-lng">

                <div class="form-group">
                    <label>Client/Business Name *</label>
                    <input type="text" id="client-name" required placeholder="e.g., ABC Company">
                </div>
                <div class="form-group address-autocomplete">
                    <label>Address *</label>
                    <input type="text" id="client-address" required placeholder="Start typing an address..." autocomplete="off">
                    <div id="address-results" class="address-results"></div>
                </div>
                <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" id="client-contact-name" placeholder="e.g., John Smith">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="client-phone" placeholder="e.g., +1 555-1234">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="client-email" placeholder="e.g., john@example.com">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="client-notes" placeholder="Any additional notes..."></textarea>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <div id="coords-display" class="coords-display">Not set - enter address or pick on map</div>
                </div>

                <button type="button" id="pick-map-btn" class="btn btn-pick-map" onclick="togglePickOnMap()">Pick on Map</button>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Visit Logs Modal -->
    <div id="logs-modal" class="modal logs-modal">
        <div class="modal-content">
            <div class="logs-header">
                <h3 id="logs-title">Visit Logs</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeLogsModal()">Close</button>
            </div>
            <div class="logs-search">
                <input type="text" id="logs-search-input" placeholder="Search logs..." oninput="searchLogs()">
            </div>
            <div id="logs-list" class="logs-list">
                <div class="log-empty">No visits logged yet</div>
            </div>
            <div class="add-log-form">
                <textarea id="new-log-notes" placeholder="Add notes about this visit (optional)..."></textarea>
                <button class="btn btn-success" onclick="checkIn()">Check In</button>
            </div>
        </div>
    </div>

    <!-- Routes Modal -->
    <div id="routes-modal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="logs-header">
                <h3>Routes</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeRoutesModal()">Close</button>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                <button class="btn" onclick="openCreateRouteModal()">+ Create Route</button>
                <button class="btn btn-purple" onclick="openTemplatesModal()">Templates</button>
            </div>
            <div id="routes-list" class="route-list">
                <div class="log-empty">No routes yet</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Route Modal -->
    <div id="route-form-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <h3 id="route-form-title">Create Route</h3>
            <div class="form-group">
                <label>Route Name *</label>
                <input type="text" id="route-name" placeholder="e.g., Monday Route">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="route-description" placeholder="e.g., Downtown clients">
            </div>
            <div class="form-group">
                <label>Select Clients (click in order)</label>
                <div id="client-select-list" class="client-select-list"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRouteFormModal()">Cancel</button>
                <button class="btn" onclick="saveRoute()">Save Route</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h3>Login to RouteView</h3>
            <form id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required placeholder="Your password">
                </div>
                <div id="login-error" style="color:#ef4444;font-size:13px;margin-bottom:8px;display:none;"></div>
                <button type="submit" class="btn" style="width:100%;">Login</button>
            </form>
            <p style="margin-top:12px;text-align:center;font-size:13px;color:#666;">
                Have an invite code? <a href="#" onclick="showRegisterScreen();return false;" style="color:#2563eb;">Register here</a>
            </p>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h3>Create Account</h3>
            <form id="register-form">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="register-name" required placeholder="Your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="register-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="register-password" required placeholder="Choose a password" minlength="6">
                </div>
                <div class="form-group">
                    <label>Invite Code</label>
                    <input type="text" id="register-invite" required placeholder="Enter your invite code">
                </div>
                <div id="register-error" style="color:#ef4444;font-size:13px;margin-bottom:8px;display:none;"></div>
                <button type="submit" class="btn" style="width:100%;">Create Account</button>
            </form>
            <p style="margin-top:12px;text-align:center;font-size:13px;color:#666;">
                Already have an account? <a href="#" onclick="showLoginScreen();return false;" style="color:#2563eb;">Login here</a>
            </p>
        </div>
    </div>

    <!-- User Management Modal (Admin) -->
    <div id="users-modal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="logs-header">
                <h3>User Management</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeUsersModal()">Close</button>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;">
                <button class="btn" onclick="openCreateUserModal()">+ Add User</button>
                <button class="btn btn-secondary" onclick="openInviteCodesModal()">Invite Codes</button>
            </div>
            <div id="users-list" class="route-list">
                <div class="log-empty">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Create User Modal (Admin) -->
    <div id="create-user-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h3>Create User</h3>
            <form id="create-user-form">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="new-user-name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="new-user-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="new-user-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="new-user-role" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
                        <option value="member">Member</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateUserModal()">Cancel</button>
                    <button type="submit" class="btn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite Codes Modal (Admin) -->
    <div id="invite-codes-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="logs-header">
                <h3>Invite Codes</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeInviteCodesModal()">Close</button>
            </div>
            <button class="btn" onclick="generateInviteCode()">+ Generate Code</button>
            <div id="invite-codes-list" class="route-list" style="margin-top:12px;">
                <div class="log-empty">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Route Templates Modal -->
    <div id="templates-modal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="logs-header">
                <h3>Route Templates</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeTemplatesModal()">Close</button>
            </div>
            <button class="btn" onclick="openCreateTemplateModal()">+ Create Template</button>
            <div id="templates-list" class="route-list" style="margin-top:12px;">
                <div class="log-empty">No templates yet</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Template Modal -->
    <div id="template-form-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <h3 id="template-form-title">Create Template</h3>
            <div class="form-group">
                <label>Template Name *</label>
                <input type="text" id="template-name" placeholder="e.g., Monday Downtown Route">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="template-description" placeholder="e.g., Weekly route for downtown clients">
            </div>
            <div class="form-group">
                <label>Schedule Days (optional)</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="0"> Mon
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="1"> Tue
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="2"> Wed
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="3"> Thu
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="4"> Fri
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="5"> Sat
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="schedule-day-checkbox" value="6"> Sun
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>Select Clients (click in order)</label>
                <div id="template-client-select-list" class="client-select-list"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeTemplateFormModal()">Cancel</button>
                <button class="btn" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Save Route As Template Modal -->
    <div id="save-template-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h3>Save as Template</h3>
            <div class="form-group">
                <label>Template Name</label>
                <input type="text" id="save-template-name" placeholder="Enter template name">
            </div>
            <div class="form-group">
                <label>Schedule Days (optional)</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="0"> Mon
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="1"> Tue
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="2"> Wed
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="3"> Thu
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="4"> Fri
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="5"> Sat
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-weight:normal;">
                        <input type="checkbox" class="save-template-day" value="6"> Sun
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeSaveTemplateModal()">Cancel</button>
                <button class="btn" onclick="confirmSaveAsTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="schedule-modal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="logs-header">
                <h3>Schedule</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeScheduleModal()">Close</button>
            </div>
            <div class="calendar-nav">
                <button onclick="prevMonth()">&larr; Prev</button>
                <h4 id="calendar-month-title">January 2026</h4>
                <button onclick="nextMonth()">Next &rarr;</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
                <div class="calendar-header">Sun</div>
            </div>
            <div id="calendar-days" class="calendar-grid" style="grid-template-columns: repeat(7, 1fr);"></div>
            <div id="assignment-form" class="assignment-form" style="display:none;">
                <h5>Assign Route</h5>
                <div class="form-group">
                    <label>Route</label>
                    <select id="assign-route-select" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
                        <option value="">Select a route...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User</label>
                    <select id="assign-user-select" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Selected Dates</label>
                    <div id="selected-dates" class="selected-dates">
                        <span style="color:#666;font-size:13px;">Click calendar days to select</span>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="clearScheduleSelection()">Clear</button>
                    <button class="btn" onclick="createAssignments()">Assign Route</button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Assignments Modal -->
    <div id="my-assignments-modal" class="modal">
        <div class="modal-content" style="max-width:450px;">
            <div class="logs-header">
                <h3>My Assignments</h3>
                <button class="btn btn-secondary" style="width:auto;padding:6px 12px;" onclick="closeMyAssignmentsModal()">Close</button>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="assignments-date" onchange="loadMyAssignments()">
            </div>
            <div id="my-assignments-list" class="route-list" style="margin-top:12px;">
                <div class="log-empty">No assignments</div>
            </div>
        </div>
    </div>

    <!-- Pick on Map Overlay -->
    <div id="pick-map-overlay" class="pick-map-overlay">
        <p>Click on the map to set location</p>
        <button class="btn btn-secondary" onclick="cancelPickOnMap()">Cancel</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // App state management
        let appState = {
            mode: 'planning',
            clientsWithStatus: [],
            filteredClients: [],
            highlightedClientId: null,
            activeRoute: null,
            currentStopIndex: 0,
            completedStops: [],
            // Map state
            initialMapLoad: true,
            // Auth state
            user: null,
            token: null,
            isAuthenticated: false
        };

        // --- Auth Functions ---

        function getToken() {
            return localStorage.getItem('routeview_token');
        }

        function setToken(token) {
            localStorage.setItem('routeview_token', token);
            appState.token = token;
        }

        function clearToken() {
            localStorage.removeItem('routeview_token');
            appState.token = null;
            appState.user = null;
            appState.isAuthenticated = false;
        }

        function authHeaders() {
            const token = getToken();
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        async function authenticatedFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
                ...authHeaders()
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                clearToken();
                showLoginScreen();
                throw new Error('Authentication required');
            }

            return response;
        }

        async function checkAuth() {
            const token = getToken();
            if (!token) {
                showLoginScreen();
                return false;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: authHeaders()
                });

                if (response.ok) {
                    appState.user = await response.json();
                    appState.isAuthenticated = true;
                    updateUserUI();
                    return true;
                } else {
                    clearToken();
                    showLoginScreen();
                    return false;
                }
            } catch (err) {
                clearToken();
                showLoginScreen();
                return false;
            }
        }

        function showLoginScreen() {
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('register-modal').classList.remove('active');
        }

        function showRegisterScreen() {
            document.getElementById('login-modal').classList.remove('active');
            document.getElementById('register-modal').classList.add('active');
        }

        function hideAuthScreens() {
            document.getElementById('login-modal').classList.remove('active');
            document.getElementById('register-modal').classList.remove('active');
        }

        function updateUserUI() {
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');

            if (appState.isAuthenticated && appState.user) {
                userName.textContent = `${appState.user.name} (${appState.user.role})`;
                userInfo.style.display = 'flex';
                updateAdminFeatures();
            } else {
                userInfo.style.display = 'none';
            }
        }

        function updateAdminFeatures() {
            const isAdmin = appState.user?.role === 'admin';
            document.querySelectorAll('[data-admin-only]').forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });
        }

        function logout() {
            clearToken();
            showLoginScreen();
        }

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('login-error');
            errorEl.style.display = 'none';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('login-email').value,
                        password: document.getElementById('login-password').value
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    setToken(data.access_token);
                    appState.user = data.user;
                    appState.isAuthenticated = true;
                    hideAuthScreens();
                    updateUserUI();
                    loadClientsWithStatus();
                } else {
                    const error = await response.json();
                    errorEl.textContent = error.detail || 'Login failed';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        });

        // Register form handler
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('register-error');
            errorEl.style.display = 'none';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('register-name').value,
                        email: document.getElementById('register-email').value,
                        password: document.getElementById('register-password').value,
                        invite_code: document.getElementById('register-invite').value
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    setToken(data.access_token);
                    appState.user = data.user;
                    appState.isAuthenticated = true;
                    hideAuthScreens();
                    updateUserUI();
                    loadClientsWithStatus();
                } else {
                    const error = await response.json();
                    errorEl.textContent = error.detail || 'Registration failed';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        });

        // --- Admin Functions ---

        async function openUsersModal() {
            await loadUsers();
            document.getElementById('users-modal').classList.add('active');
        }

        function closeUsersModal() {
            document.getElementById('users-modal').classList.remove('active');
        }

        async function loadUsers() {
            try {
                const response = await authenticatedFetch('/api/users');
                const users = await response.json();

                const listEl = document.getElementById('users-list');
                if (users.length === 0) {
                    listEl.innerHTML = '<div class="log-empty">No users found</div>';
                } else {
                    listEl.innerHTML = users.map(u => `
                        <div class="route-item" style="cursor:default;">
                            <h4>${u.name} ${u.id === appState.user.id ? '(you)' : ''}</h4>
                            <small>${u.email} - ${u.role} ${u.is_active ? '' : '(inactive)'}</small>
                            ${u.id !== appState.user.id ? `
                                <div style="margin-top:8px;">
                                    <button class="btn btn-secondary" style="width:auto;padding:4px 8px;font-size:12px;"
                                        onclick="toggleUserActive(${u.id}, ${!u.is_active})">
                                        ${u.is_active ? 'Deactivate' : 'Activate'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load users:', err);
            }
        }

        async function toggleUserActive(userId, active) {
            try {
                await authenticatedFetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_active: active })
                });
                loadUsers();
            } catch (err) {
                console.error('Failed to update user:', err);
            }
        }

        function openCreateUserModal() {
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = 'member';
            closeUsersModal();
            document.getElementById('create-user-modal').classList.add('active');
        }

        function closeCreateUserModal() {
            document.getElementById('create-user-modal').classList.remove('active');
        }

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                const response = await authenticatedFetch('/api/users', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: document.getElementById('new-user-name').value,
                        email: document.getElementById('new-user-email').value,
                        password: document.getElementById('new-user-password').value,
                        role: document.getElementById('new-user-role').value
                    })
                });

                if (response.ok) {
                    closeCreateUserModal();
                    openUsersModal();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to create user');
                }
            } catch (err) {
                alert('Error creating user');
            }
        });

        // --- Invite Codes ---

        function openInviteCodesModal() {
            closeUsersModal();
            loadInviteCodes();
            document.getElementById('invite-codes-modal').classList.add('active');
        }

        function closeInviteCodesModal() {
            document.getElementById('invite-codes-modal').classList.remove('active');
        }

        async function loadInviteCodes() {
            try {
                const response = await authenticatedFetch('/api/invite-codes');
                const codes = await response.json();

                const listEl = document.getElementById('invite-codes-list');
                if (codes.length === 0) {
                    listEl.innerHTML = '<div class="log-empty">No invite codes</div>';
                } else {
                    listEl.innerHTML = codes.map(c => {
                        const isExpired = new Date(c.expires_at) < new Date();
                        const isUsed = c.used_by !== null;
                        return `
                            <div class="route-item" style="cursor:default;">
                                <h4 style="font-family:monospace;">${c.code}</h4>
                                <small>
                                    ${isUsed ? 'Used' : isExpired ? 'Expired' : `Expires: ${new Date(c.expires_at).toLocaleDateString()}`}
                                </small>
                                ${!isUsed ? `
                                    <button class="btn btn-danger" style="width:auto;padding:4px 8px;font-size:12px;margin-top:8px;"
                                        onclick="deleteInviteCode(${c.id})">Delete</button>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Failed to load invite codes:', err);
            }
        }

        async function generateInviteCode() {
            try {
                const response = await authenticatedFetch('/api/invite-codes', {
                    method: 'POST',
                    body: JSON.stringify({ expires_in_days: 7 })
                });

                if (response.ok) {
                    const code = await response.json();
                    alert(`New invite code: ${code.code}\n\nShare this with the person you want to invite.`);
                    loadInviteCodes();
                }
            } catch (err) {
                alert('Error generating invite code');
            }
        }

        async function deleteInviteCode(codeId) {
            if (!confirm('Delete this invite code?')) return;

            try {
                await authenticatedFetch(`/api/invite-codes/${codeId}`, { method: 'DELETE' });
                loadInviteCodes();
            } catch (err) {
                alert('Error deleting invite code');
            }
        }

        // Initialize map (centered on Europe - adjust as needed)
        const map = L.map('map').setView([41.9981, 21.4254], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let clientMarkers = {};
        let tempMarker = null;
        let isPickingOnMap = false;
        let savedMapView = null; // Save map state before modal opens
        let allClients = [];
        let addressSearchTimeout = null;

        // Color-coded markers based on service status
        function getStatusColor(status) {
            const colors = {
                green: '#22c55e',
                orange: '#f97316',
                red: '#ef4444',
                never: '#9ca3af'
            };
            return colors[status] || colors.never;
        }

        function createColoredMarker(client) {
            const color = getStatusColor(client.service_status);

            return L.circleMarker([client.latitude, client.longitude], {
                radius: 10,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            });
        }

        function highlightClientInList(clientId) {
            appState.highlightedClientId = clientId;

            // Update visual highlight in list
            document.querySelectorAll('.client-item').forEach(el => {
                el.classList.toggle('highlighted', el.dataset.id == clientId);
            });

            // Scroll into view
            const element = document.querySelector(`.client-item[data-id="${clientId}"]`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Mobile panel toggle
        function togglePanel() {
            document.getElementById('left-panel').classList.toggle('open');
        }

        // Close panel when clicking on map (mobile)
        map.on('click', function(e) {
            if (window.innerWidth <= 768) {
                document.getElementById('left-panel').classList.remove('open');
            }

            // Handle pick on map mode
            if (isPickingOnMap) {
                handleMapClick(e);
            }
        });

        // Mode switching
        function setMode(mode) {
            appState.mode = mode;

            // Update toggle buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Show/hide content
            document.getElementById('planning-content').style.display = mode === 'planning' ? 'flex' : 'none';
            document.getElementById('execution-content').style.display = mode === 'execution' ? 'flex' : 'none';

            // If switching to execution and no route, show route selection
            if (mode === 'execution' && !appState.activeRoute) {
                openRoutesModal();
            }
        }

        // Initialize app - check auth first
        async function initApp() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadClientsWithStatus();
            }
        }
        initApp();

        // Load clients with service status
        async function loadClientsWithStatus() {
            try {
                const response = await authenticatedFetch('/api/clients/with-status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                appState.clientsWithStatus = await response.json();
                appState.filteredClients = [...appState.clientsWithStatus];
                allClients = appState.clientsWithStatus;
                renderClientList();
                renderMarkers();
                setupMapSync(); // Initialize bidirectional sync after clients are loaded
            } catch (err) {
                console.error('Failed to load clients with status:', err);
                // Fallback to regular clients endpoint
                try {
                    const response = await authenticatedFetch('/api/clients');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const clients = await response.json();
                    appState.clientsWithStatus = clients.map(c => ({
                        ...c,
                        service_status: 'never',
                        last_serviced: null
                    }));
                    appState.filteredClients = [...appState.clientsWithStatus];
                    allClients = appState.clientsWithStatus;
                    renderClientList();
                    renderMarkers();
                    setupMapSync(); // Initialize bidirectional sync after clients are loaded
                } catch (fallbackErr) {
                    console.error('Failed to load clients (fallback):', fallbackErr);
                }
            }
        }

        // Render client list in left panel
        function renderClientList() {
            const listEl = document.getElementById('client-list');
            const clients = appState.filteredClients;

            if (clients.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No clients found</div>';
                return;
            }

            listEl.innerHTML = clients.map(client => `
                <div class="client-item ${appState.highlightedClientId === client.id ? 'highlighted' : ''}"
                     data-id="${client.id}"
                     onclick="handleClientClick(${client.id})">
                    <div class="status-dot status-${client.service_status || 'never'}"></div>
                    <div class="client-item-info">
                        <div class="client-item-name">${client.name}</div>
                        <div class="client-item-address">${client.address || 'No address'}</div>
                        <div class="client-item-last">${formatLastServiced(client.last_serviced)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatLastServiced(dateString) {
            if (!dateString) return 'Never serviced';
            const date = new Date(dateString);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Serviced today';
            if (diffDays === 1) return 'Serviced yesterday';
            if (diffDays < 7) return `Serviced ${diffDays} days ago`;
            if (diffDays < 30) return `Serviced ${Math.floor(diffDays / 7)} weeks ago`;
            return `Serviced ${Math.floor(diffDays / 30)} months ago`;
        }

        // Filter client list in left panel
        function filterClientList() {
            const query = document.getElementById('client-search').value.toLowerCase().trim();

            if (query.length === 0) {
                // If no search, show clients in viewport
                filterClientsByViewport();
                return;
            }

            // If searching, search ALL clients (not just viewport)
            appState.filteredClients = appState.clientsWithStatus.filter(client =>
                client.name.toLowerCase().includes(query) ||
                (client.address && client.address.toLowerCase().includes(query)) ||
                (client.contact_name && client.contact_name.toLowerCase().includes(query))
            );

            renderClientList();

            // Update count
            const countEl = document.getElementById('count');
            if (countEl) {
                countEl.textContent = `${appState.filteredClients.length} matches`;
            }

            // Hide "Show all" link when searching
            const showAllLink = document.getElementById('show-all-link');
            if (showAllLink) {
                showAllLink.style.display = 'none';
            }
        }

        // Handle client click in left panel
        function handleClientClick(clientId) {
            const client = appState.clientsWithStatus.find(c => c.id === clientId);
            if (!client || !client.latitude || !client.longitude) return;

            // Highlight in list
            highlightClientInList(clientId);

            // Pan map to client with smooth animation
            map.flyTo([client.latitude, client.longitude], 16, { duration: 0.5 });

            // Open popup after animation completes
            setTimeout(() => {
                if (clientMarkers[clientId]) {
                    clientMarkers[clientId].openPopup();
                }
            }, 600);

            // Close mobile panel
            if (window.innerWidth <= 768) {
                document.getElementById('left-panel').classList.remove('open');
            }
        }

        // Render markers on map
        function renderMarkers() {
            // Clear existing markers
            Object.values(clientMarkers).forEach(m => map.removeLayer(m));
            clientMarkers = {};

            // Add markers for clients with coordinates
            const clientsWithCoords = appState.clientsWithStatus.filter(c => c.latitude && c.longitude);

            clientsWithCoords.forEach(client => {
                const marker = createColoredMarker(client);
                marker.addTo(map);
                marker.bindPopup(createPopupContent(client));

                // Sync marker click with list
                marker.on('click', () => {
                    highlightClientInList(client.id);
                });

                clientMarkers[client.id] = marker;
            });

            // Fit bounds only on initial page load, not after adding/editing clients
            if (clientsWithCoords.length > 0 && appState.initialMapLoad) {
                const bounds = L.latLngBounds(clientsWithCoords.map(c => [c.latitude, c.longitude]));
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                appState.initialMapLoad = false;
            }

            // Update count
            const countEl = document.getElementById('count');
            if (countEl) countEl.textContent = appState.clientsWithStatus.length;
        }

        function createPopupContent(client) {
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${client.latitude},${client.longitude}`;
            const statusColor = getStatusColor(client.service_status);
            const statusLabel = {
                green: 'Recently serviced',
                orange: 'Due soon',
                red: 'Overdue',
                never: 'Never serviced'
            }[client.service_status] || 'Never serviced';

            return `
                <div class="popup-content">
                    <h4>${client.name}</h4>
                    <p style="margin-bottom:6px;">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusColor};margin-right:6px;"></span>
                        <strong>${statusLabel}</strong>
                        ${client.last_serviced ? ` - ${formatLastServiced(client.last_serviced)}` : ''}
                    </p>
                    ${client.address ? `<p style="margin-bottom:4px;">${client.address}</p>` : ''}
                    ${client.contact_name ? `<p style="margin-bottom:2px;"><strong>Contact:</strong> ${client.contact_name}</p>` : ''}
                    ${client.contact_phone ? `<p style="margin-bottom:2px;"><strong>Phone:</strong> <a href="tel:${client.contact_phone}">${client.contact_phone}</a></p>` : ''}
                    ${client.contact_email ? `<p style="margin-bottom:2px;"><strong>Email:</strong> <a href="mailto:${client.contact_email}">${client.contact_email}</a></p>` : ''}
                    ${client.notes ? `<p style="margin-top:6px;font-style:italic;color:#666;">${client.notes}</p>` : ''}
                    <div class="popup-buttons">
                        <a href="${directionsUrl}" target="_blank" class="btn btn-success" style="text-decoration:none;text-align:center;">Directions</a>
                        <button class="btn btn-orange" onclick="openLogs(${client.id}, '${client.name.replace(/'/g, "\\'")}')">Logs</button>
                        <button class="btn" onclick="editClient(${client.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteClient(${client.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        // Close address results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-autocomplete')) {
                document.getElementById('address-results').classList.remove('active');
            }
        });

        // Open Add Client modal directly
        function startAddClient() {
            // Save current map view to restore after modal closes
            savedMapView = {
                center: map.getCenter(),
                zoom: map.getZoom()
            };

            document.getElementById('modal-title').textContent = 'Add Client';
            document.getElementById('client-id').value = '';
            document.getElementById('client-lat').value = '';
            document.getElementById('client-lng').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-address').value = '';
            document.getElementById('client-contact-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-notes').value = '';
            document.getElementById('coords-display').textContent = 'Not set - enter address or pick on map';
            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            openModal();
        }

        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('pick-map-overlay').classList.remove('active');
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            // Restore map to original position before modal was opened
            if (savedMapView) {
                map.setView(savedMapView.center, savedMapView.zoom, { animate: false });
                savedMapView = null;
            }
        }

        async function editClient(id) {
            // Save current map view to restore after modal closes
            savedMapView = {
                center: map.getCenter(),
                zoom: map.getZoom()
            };

            const response = await authenticatedFetch(`/api/clients/${id}`);
            const client = await response.json();

            document.getElementById('modal-title').textContent = 'Edit Client';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-lat').value = client.latitude || '';
            document.getElementById('client-lng').value = client.longitude || '';
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-contact-name').value = client.contact_name || '';
            document.getElementById('client-phone').value = client.contact_phone || '';
            document.getElementById('client-email').value = client.contact_email || '';
            document.getElementById('client-notes').value = client.notes || '';

            if (client.latitude && client.longitude) {
                document.getElementById('coords-display').textContent =
                    `${client.latitude.toFixed(6)}, ${client.longitude.toFixed(6)}`;
            } else {
                document.getElementById('coords-display').textContent = 'Not set - enter address or pick on map';
            }

            document.getElementById('pick-map-btn').textContent = 'Pick on Map';
            document.getElementById('pick-map-btn').classList.remove('active');

            openModal();
        }

        async function deleteClient(id) {
            if (!confirm('Delete this client?')) return;

            await authenticatedFetch(`/api/clients/${id}`, { method: 'DELETE' });
            loadClientsWithStatus();
        }

        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('client-id').value;
            const lat = document.getElementById('client-lat').value;
            const lng = document.getElementById('client-lng').value;

            if (!lat || !lng) {
                alert('Please set a location by entering an address or picking on the map');
                return;
            }

            const data = {
                name: document.getElementById('client-name').value,
                address: document.getElementById('client-address').value || null,
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                contact_name: document.getElementById('client-contact-name').value || null,
                contact_phone: document.getElementById('client-phone').value || null,
                contact_email: document.getElementById('client-email').value || null,
                notes: document.getElementById('client-notes').value || null
            };

            const url = id ? `/api/clients/${id}` : '/api/clients';
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await authenticatedFetch(url, {
                    method,
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    let errorMessage = `Server error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || JSON.stringify(errorData);
                    } catch (parseErr) {
                        // Response wasn't JSON, use status text
                        errorMessage = `${response.status}: ${response.statusText}`;
                    }
                    console.error('Client save failed:', errorMessage, { status: response.status, data });
                    alert(`Failed to save client: ${errorMessage}`);
                    return;
                }

                closeModal();
                loadClientsWithStatus();
            } catch (err) {
                console.error('Client save error:', err, { data });
                alert(`Failed to save client: ${err.message}`);
            }
        });

        // --- Address Autocomplete with Nominatim ---
        const addressInput = document.getElementById('client-address');
        const addressResultsEl = document.getElementById('address-results');

        addressInput.addEventListener('input', function() {
            clearTimeout(addressSearchTimeout);
            const query = this.value.trim();

            if (query.length < 3) {
                addressResultsEl.classList.remove('active');
                return;
            }

            addressResultsEl.innerHTML = '<div class="address-loading">Searching...</div>';
            addressResultsEl.classList.add('active');

            addressSearchTimeout = setTimeout(() => {
                searchAddress(query);
            }, 300);
        });

        async function searchAddress(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`,
                    { headers: { 'User-Agent': 'RouteView/1.0' } }
                );
                const results = await response.json();

                if (results.length === 0) {
                    addressResultsEl.innerHTML = '<div class="address-loading">No results found</div>';
                } else {
                    addressResultsEl.innerHTML = results.map((r, idx) => `
                        <div class="address-result-item" onclick="selectAddress(${idx})">
                            ${r.display_name}
                        </div>
                    `).join('');
                    window._addressResults = results;
                }
            } catch (err) {
                addressResultsEl.innerHTML = '<div class="address-loading">Search failed</div>';
            }
        }

        function selectAddress(idx) {
            const result = window._addressResults[idx];
            if (!result) return;

            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);

            document.getElementById('client-address').value = result.display_name;
            document.getElementById('client-lat').value = lat;
            document.getElementById('client-lng').value = lng;
            document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            addressResultsEl.classList.remove('active');

            // Center map and show temp marker
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);
            map.flyTo([lat, lng], 16);
        }

        // --- Pick on Map ---
        function togglePickOnMap() {
            if (isPickingOnMap) {
                cancelPickOnMap();
            } else {
                startPickOnMap();
            }
        }

        function startPickOnMap() {
            isPickingOnMap = true;
            map.getContainer().style.cursor = 'crosshair';

            // Hide modal, show overlay
            document.getElementById('modal').classList.remove('active');
            document.getElementById('pick-map-overlay').classList.add('active');
        }

        function cancelPickOnMap() {
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';

            // Hide overlay, show modal
            document.getElementById('pick-map-overlay').classList.remove('active');
            document.getElementById('modal').classList.add('active');
        }

        async function handleMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // Set coordinates
            document.getElementById('client-lat').value = lat;
            document.getElementById('client-lng').value = lng;
            document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            // Show temp marker
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng]).addTo(map);

            // Reverse geocode to get address
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                    { headers: { 'User-Agent': 'RouteView/1.0' } }
                );
                const result = await response.json();
                if (result.display_name) {
                    document.getElementById('client-address').value = result.display_name;
                }
            } catch (err) {
                // Ignore reverse geocode errors
            }

            // Hide overlay, show modal with filled data
            isPickingOnMap = false;
            map.getContainer().style.cursor = '';
            document.getElementById('pick-map-overlay').classList.remove('active');
            document.getElementById('modal').classList.add('active');
        }

        // --- Visit Logs ---
        let currentClientId = null;
        let currentClientName = '';

        async function openLogs(clientId, clientName) {
            currentClientId = clientId;
            currentClientName = clientName;
            document.getElementById('logs-title').textContent = `Logs: ${clientName}`;
            document.getElementById('logs-search-input').value = '';
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            document.getElementById('logs-modal').classList.add('active');
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.remove('active');
            currentClientId = null;
        }

        async function loadLogs(search = '') {
            const url = `/api/clients/${currentClientId}/logs` + (search ? `?search=${encodeURIComponent(search)}` : '');
            const response = await authenticatedFetch(url);
            const logs = await response.json();

            const listEl = document.getElementById('logs-list');
            if (logs.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No visits logged yet</div>';
            } else {
                listEl.innerHTML = logs.map(log => `
                    <div class="log-item">
                        <h4>${log.title}</h4>
                        ${log.notes ? `<p>${log.notes}</p>` : '<p style="font-style:italic;">No notes</p>'}
                        <div class="log-meta">${new Date(log.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        let searchLogsTimeout;
        function searchLogs() {
            clearTimeout(searchLogsTimeout);
            const query = document.getElementById('logs-search-input').value;
            searchLogsTimeout = setTimeout(() => loadLogs(query), 300);
        }

        async function checkIn() {
            const notes = document.getElementById('new-log-notes').value.trim();
            await authenticatedFetch(`/api/clients/${currentClientId}/logs`, {
                method: 'POST',
                body: JSON.stringify({ notes: notes || null })
            });
            document.getElementById('new-log-notes').value = '';
            await loadLogs();
            // Refresh clients to update service status
            loadClientsWithStatus();
        }

        // Check in from execution panel
        async function checkInFromPanel() {
            if (!appState.activeRoute) return;

            const stop = appState.activeRoute.clients[appState.currentStopIndex];
            const client = stop.client;
            const notes = document.getElementById('exec-checkin-notes').value.trim();

            await authenticatedFetch(`/api/clients/${client.id}/logs`, {
                method: 'POST',
                body: JSON.stringify({ notes: notes || null })
            });

            document.getElementById('exec-checkin-notes').value = '';

            // Mark stop as completed
            appState.completedStops.push(appState.currentStopIndex);

            // Move to next stop if available
            if (appState.currentStopIndex < appState.activeRoute.clients.length - 1) {
                appState.currentStopIndex++;
                updateExecutionPanel();
            } else {
                alert('Route complete! All stops visited.');
            }

            // Refresh clients to update service status
            loadClientsWithStatus();
        }

        // --- Routes ---
        let selectedClientIds = [];
        let editingRouteId = null;

        async function openRoutesModal() {
            await loadRoutes();
            document.getElementById('routes-modal').classList.add('active');
        }

        function closeRoutesModal() {
            document.getElementById('routes-modal').classList.remove('active');
        }

        async function loadRoutes() {
            const response = await authenticatedFetch('/api/routes');
            const routes = await response.json();

            const listEl = document.getElementById('routes-list');
            if (routes.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No routes yet</div>';
            } else {
                listEl.innerHTML = routes.map(r => `
                    <div class="route-item" onclick="startRoute(${r.id})">
                        <h4>${r.name}</h4>
                        <small>${r.client_count} stops${r.description ? ' - ' + r.description : ''}</small>
                    </div>
                `).join('');
            }
        }

        function openCreateRouteModal() {
            editingRouteId = null;
            selectedClientIds = [];
            document.getElementById('route-form-title').textContent = 'Create Route';
            document.getElementById('route-name').value = '';
            document.getElementById('route-description').value = '';
            renderClientSelectList();
            closeRoutesModal();
            document.getElementById('route-form-modal').classList.add('active');
        }

        function closeRouteFormModal() {
            document.getElementById('route-form-modal').classList.remove('active');
        }

        function renderClientSelectList() {
            const listEl = document.getElementById('client-select-list');
            // Only show clients with coordinates for route selection
            const clientsWithCoords = allClients.filter(c => c.latitude && c.longitude);
            listEl.innerHTML = clientsWithCoords.map(client => {
                const idx = selectedClientIds.indexOf(client.id);
                const isSelected = idx !== -1;
                return `
                    <div class="client-select-item ${isSelected ? 'selected' : ''}" onclick="toggleClientSelect(${client.id})">
                        <div class="client-order">${isSelected ? idx + 1 : ''}</div>
                        <div>
                            <strong>${client.name}</strong><br>
                            <small style="color:#666;">${client.address || 'No address'}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleClientSelect(clientId) {
            const idx = selectedClientIds.indexOf(clientId);
            if (idx === -1) {
                selectedClientIds.push(clientId);
            } else {
                selectedClientIds.splice(idx, 1);
            }
            renderClientSelectList();
        }

        async function saveRoute() {
            const name = document.getElementById('route-name').value.trim();
            if (!name) {
                alert('Please enter a route name');
                return;
            }
            if (selectedClientIds.length === 0) {
                alert('Please select at least one client');
                return;
            }

            const data = {
                name,
                description: document.getElementById('route-description').value.trim() || null,
                client_ids: selectedClientIds
            };

            const url = editingRouteId ? `/api/routes/${editingRouteId}` : '/api/routes';
            const method = editingRouteId ? 'PUT' : 'POST';

            await authenticatedFetch(url, {
                method,
                body: JSON.stringify(data)
            });

            closeRouteFormModal();
            openRoutesModal();
        }

        async function startRoute(routeId) {
            const response = await authenticatedFetch(`/api/routes/${routeId}`);
            appState.activeRoute = await response.json();
            appState.currentStopIndex = 0;
            appState.completedStops = [];

            if (appState.activeRoute.clients.length === 0) {
                alert('This route has no clients');
                return;
            }

            closeRoutesModal();
            setMode('execution');
            updateExecutionPanel();
        }

        function updateExecutionPanel() {
            if (!appState.activeRoute) return;

            const route = appState.activeRoute;
            const currentIndex = appState.currentStopIndex;

            document.getElementById('exec-route-name').textContent = route.name;
            document.getElementById('exec-route-progress').textContent =
                `Stop ${currentIndex + 1} of ${route.clients.length}`;

            // Render stops list
            const stopsListEl = document.getElementById('route-stops-list');
            stopsListEl.innerHTML = route.clients.map((stop, idx) => {
                const client = stop.client;
                const isCompleted = appState.completedStops.includes(idx);
                const isCurrent = idx === currentIndex;

                return `
                    <div class="route-stop ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}"
                         onclick="goToStop(${idx})">
                        <div class="stop-number">${isCompleted ? '&#10003;' : idx + 1}</div>
                        <div class="client-item-info">
                            <div class="client-item-name">${client.name}</div>
                            <div class="client-item-address">${client.address || 'No address'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show actions for current stop
            const actionsEl = document.getElementById('exec-actions');
            actionsEl.style.display = 'flex';

            // Update directions link
            const currentStop = route.clients[currentIndex];
            const client = currentStop.client;
            document.getElementById('exec-directions-btn').href =
                `https://www.google.com/maps/dir/?api=1&destination=${client.latitude},${client.longitude}`;

            // Pan to current stop
            map.flyTo([client.latitude, client.longitude], 16);
            setTimeout(() => clientMarkers[client.id]?.openPopup(), 500);
        }

        function goToStop(idx) {
            appState.currentStopIndex = idx;
            updateExecutionPanel();
        }

        function exitRouteExecution() {
            appState.activeRoute = null;
            appState.currentStopIndex = 0;
            appState.completedStops = [];
            document.getElementById('exec-actions').style.display = 'none';
            document.getElementById('exec-route-name').textContent = 'No route selected';
            document.getElementById('exec-route-progress').textContent = '';
            document.getElementById('route-stops-list').innerHTML = '<div class="empty-state">Select a route to start</div>';
            setMode('planning');
        }

        // --- Bidirectional Map-List Sync ---
        let mapMoveTimeout = null;
        let mapSyncInitialized = false;

        function setupMapSync() {
            // Only set up once
            if (mapSyncInitialized) return;
            mapSyncInitialized = true;

            map.on('moveend', handleMapMove);
            map.on('zoomend', handleMapMove);
        }

        function handleMapMove() {
            // Skip if in execution mode or if user is searching
            if (appState.mode === 'execution') return;
            const searchQuery = document.getElementById('client-search')?.value?.trim();
            if (searchQuery && searchQuery.length > 0) return;

            // Debounce to avoid excessive updates
            clearTimeout(mapMoveTimeout);
            mapMoveTimeout = setTimeout(() => {
                filterClientsByViewport();
            }, 150);
        }

        function filterClientsByViewport() {
            const bounds = map.getBounds();

            // Filter clients to those visible in current viewport
            appState.filteredClients = appState.clientsWithStatus.filter(client => {
                if (!client.latitude || !client.longitude) return false;
                return bounds.contains([client.latitude, client.longitude]);
            });

            // Re-render the client list
            renderClientList();

            // Update the count to show filtered/total
            const countEl = document.getElementById('count');
            const showAllLink = document.getElementById('show-all-link');

            if (countEl) {
                const total = appState.clientsWithStatus.length;
                const visible = appState.filteredClients.length;
                countEl.textContent = visible === total ? total : `${visible} of ${total}`;
            }

            // Show/hide "Show all" link
            if (showAllLink) {
                const total = appState.clientsWithStatus.length;
                const visible = appState.filteredClients.length;
                showAllLink.style.display = visible < total ? 'inline' : 'none';
            }
        }

        function showAllClients() {
            // Clear search input
            const searchInput = document.getElementById('client-search');
            if (searchInput) {
                searchInput.value = '';
            }

            appState.filteredClients = [...appState.clientsWithStatus];
            renderClientList();

            // Fit map to all clients
            const clientsWithCoords = appState.clientsWithStatus.filter(c => c.latitude && c.longitude);
            if (clientsWithCoords.length > 0) {
                const bounds = L.latLngBounds(clientsWithCoords.map(c => [c.latitude, c.longitude]));
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
            }

            // Update count
            const countEl = document.getElementById('count');
            if (countEl) {
                countEl.textContent = appState.clientsWithStatus.length;
            }

            // Hide "Show all" link
            const showAllLink = document.getElementById('show-all-link');
            if (showAllLink) {
                showAllLink.style.display = 'none';
            }
        }

        // --- Route Templates ---
        let templateClientIds = [];
        let editingTemplateId = null;
        let saveAsTemplateRouteId = null;

        function openTemplatesModal() {
            closeRoutesModal();
            loadTemplates();
            document.getElementById('templates-modal').classList.add('active');
        }

        function closeTemplatesModal() {
            document.getElementById('templates-modal').classList.remove('active');
        }

        async function loadTemplates() {
            try {
                const response = await authenticatedFetch('/api/route-templates');
                const templates = await response.json();

                const listEl = document.getElementById('templates-list');
                if (templates.length === 0) {
                    listEl.innerHTML = '<div class="log-empty">No templates yet. Create one from a route or start fresh.</div>';
                } else {
                    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    listEl.innerHTML = templates.map(t => {
                        const scheduleDays = t.schedule_days ? t.schedule_days.split(',').map(d => dayNames[parseInt(d)]) : [];
                        return `
                            <div class="template-item">
                                <div class="template-info">
                                    <h4>${t.name}</h4>
                                    <small>${t.client_count} stops${t.description ? ' - ' + t.description : ''}</small>
                                    ${scheduleDays.length > 0 ? `
                                        <div class="schedule-days-tags">
                                            ${scheduleDays.map(d => `<span class="schedule-day-tag">${d}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="template-actions">
                                    <button class="btn btn-success" onclick="createRouteFromTemplate(${t.id})">Use</button>
                                    <button class="btn btn-secondary" onclick="editTemplate(${t.id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteTemplate(${t.id})">Del</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Failed to load templates:', err);
            }
        }

        function openCreateTemplateModal() {
            editingTemplateId = null;
            templateClientIds = [];
            document.getElementById('template-form-title').textContent = 'Create Template';
            document.getElementById('template-name').value = '';
            document.getElementById('template-description').value = '';
            document.querySelectorAll('.schedule-day-checkbox').forEach(cb => cb.checked = false);
            renderTemplateClientSelectList();
            closeTemplatesModal();
            document.getElementById('template-form-modal').classList.add('active');
        }

        function closeTemplateFormModal() {
            document.getElementById('template-form-modal').classList.remove('active');
        }

        function renderTemplateClientSelectList() {
            const listEl = document.getElementById('template-client-select-list');
            const clientsWithCoords = allClients.filter(c => c.latitude && c.longitude);
            listEl.innerHTML = clientsWithCoords.map(client => {
                const idx = templateClientIds.indexOf(client.id);
                const isSelected = idx !== -1;
                return `
                    <div class="client-select-item ${isSelected ? 'selected' : ''}" onclick="toggleTemplateClientSelect(${client.id})">
                        <div class="client-order">${isSelected ? idx + 1 : ''}</div>
                        <div>
                            <strong>${client.name}</strong><br>
                            <small style="color:#666;">${client.address || 'No address'}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTemplateClientSelect(clientId) {
            const idx = templateClientIds.indexOf(clientId);
            if (idx === -1) {
                templateClientIds.push(clientId);
            } else {
                templateClientIds.splice(idx, 1);
            }
            renderTemplateClientSelectList();
        }

        function getSelectedScheduleDays() {
            const days = [];
            document.querySelectorAll('.schedule-day-checkbox:checked').forEach(cb => {
                days.push(cb.value);
            });
            return days.length > 0 ? days.join(',') : null;
        }

        async function saveTemplate() {
            const name = document.getElementById('template-name').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }
            if (templateClientIds.length === 0) {
                alert('Please select at least one client');
                return;
            }

            const data = {
                name,
                description: document.getElementById('template-description').value.trim() || null,
                client_ids: templateClientIds,
                schedule_days: getSelectedScheduleDays()
            };

            const url = editingTemplateId ? `/api/route-templates/${editingTemplateId}` : '/api/route-templates';
            const method = editingTemplateId ? 'PUT' : 'POST';

            try {
                await authenticatedFetch(url, {
                    method,
                    body: JSON.stringify(data)
                });

                closeTemplateFormModal();
                openTemplatesModal();
            } catch (err) {
                alert('Error saving template');
            }
        }

        async function editTemplate(templateId) {
            try {
                const response = await authenticatedFetch(`/api/route-templates/${templateId}`);
                const template = await response.json();

                editingTemplateId = templateId;
                templateClientIds = template.client_ids || [];
                document.getElementById('template-form-title').textContent = 'Edit Template';
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-description').value = template.description || '';

                // Set schedule day checkboxes
                document.querySelectorAll('.schedule-day-checkbox').forEach(cb => cb.checked = false);
                if (template.schedule_days) {
                    template.schedule_days.split(',').forEach(d => {
                        const cb = document.querySelector(`.schedule-day-checkbox[value="${d}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                renderTemplateClientSelectList();
                closeTemplatesModal();
                document.getElementById('template-form-modal').classList.add('active');
            } catch (err) {
                alert('Error loading template');
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Delete this template?')) return;

            try {
                await authenticatedFetch(`/api/route-templates/${templateId}`, { method: 'DELETE' });
                loadTemplates();
            } catch (err) {
                alert('Error deleting template');
            }
        }

        async function createRouteFromTemplate(templateId) {
            const name = prompt('Enter route name (or leave empty for auto-generated name):');

            try {
                const url = `/api/route-templates/${templateId}/create-route${name ? `?name=${encodeURIComponent(name)}` : ''}`;
                const response = await authenticatedFetch(url, { method: 'POST' });
                const route = await response.json();

                alert(`Route "${route.name}" created with ${route.client_count} stops!`);
                closeTemplatesModal();
                openRoutesModal();
            } catch (err) {
                alert('Error creating route from template');
            }
        }

        // Save route as template
        function openSaveAsTemplateModal(routeId, routeName) {
            saveAsTemplateRouteId = routeId;
            document.getElementById('save-template-name').value = routeName + ' Template';
            document.querySelectorAll('.save-template-day').forEach(cb => cb.checked = false);
            closeRoutesModal();
            document.getElementById('save-template-modal').classList.add('active');
        }

        function closeSaveTemplateModal() {
            document.getElementById('save-template-modal').classList.remove('active');
        }

        async function confirmSaveAsTemplate() {
            const name = document.getElementById('save-template-name').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            const days = [];
            document.querySelectorAll('.save-template-day:checked').forEach(cb => days.push(cb.value));
            const scheduleDays = days.length > 0 ? days.join(',') : null;

            try {
                let url = `/api/routes/${saveAsTemplateRouteId}/save-as-template?name=${encodeURIComponent(name)}`;
                if (scheduleDays) {
                    url += `&schedule_days=${encodeURIComponent(scheduleDays)}`;
                }

                const response = await authenticatedFetch(url, { method: 'POST' });
                const template = await response.json();

                alert(`Template "${template.name}" created!`);
                closeSaveTemplateModal();
            } catch (err) {
                alert('Error saving template');
            }
        }

        // --- Schedule / Calendar ---
        let scheduleState = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            assignments: [],
            selectedDates: [],
            routes: [],
            users: []
        };

        function openScheduleModal() {
            scheduleState.selectedDates = [];
            loadScheduleData();
            document.getElementById('schedule-modal').classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('active');
        }

        async function loadScheduleData() {
            // Load routes and users for assignment form
            try {
                const [routesRes, usersRes] = await Promise.all([
                    authenticatedFetch('/api/routes'),
                    authenticatedFetch('/api/users')
                ]);

                scheduleState.routes = await routesRes.json();
                scheduleState.users = await usersRes.json();

                // Populate route dropdown
                const routeSelect = document.getElementById('assign-route-select');
                routeSelect.innerHTML = '<option value="">Select a route...</option>' +
                    scheduleState.routes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

                // Populate user dropdown
                const userSelect = document.getElementById('assign-user-select');
                userSelect.innerHTML = '<option value="">Select a user...</option>' +
                    scheduleState.users.filter(u => u.is_active).map(u => `<option value="${u.id}">${u.name}</option>`).join('');

            } catch (err) {
                console.error('Error loading schedule data:', err);
            }

            loadCalendarMonth();
        }

        async function loadCalendarMonth() {
            const year = scheduleState.currentYear;
            const month = scheduleState.currentMonth;

            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Get start of calendar (may include days from previous month)
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - ((firstDay.getDay() + 6) % 7)); // Start from Monday

            // Get end of calendar (may include days from next month)
            const endDate = new Date(lastDay);
            const daysToAdd = (7 - lastDay.getDay()) % 7;
            if (daysToAdd === 0 && lastDay.getDay() !== 0) {
                endDate.setDate(endDate.getDate() + 7);
            } else {
                endDate.setDate(endDate.getDate() + daysToAdd);
            }

            // Update month title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-title').textContent = `${monthNames[month]} ${year}`;

            // Load assignments for this range
            try {
                const response = await authenticatedFetch(
                    `/api/schedule?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`
                );
                scheduleState.assignments = await response.json();
            } catch (err) {
                console.error('Error loading assignments:', err);
                scheduleState.assignments = [];
            }

            renderCalendar(startDate, endDate, month);
        }

        function renderCalendar(startDate, endDate, currentMonth) {
            const calendarEl = document.getElementById('calendar-days');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '';
            let current = new Date(startDate);

            while (current <= endDate) {
                const dateStr = formatDate(current);
                const isOtherMonth = current.getMonth() !== currentMonth;
                const isToday = current.getTime() === today.getTime();
                const isSelected = scheduleState.selectedDates.includes(dateStr);

                // Get assignments for this day
                const dayAssignments = scheduleState.assignments.filter(a => a.assigned_date === dateStr);

                html += `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}"
                         onclick="toggleCalendarDate('${dateStr}')">
                        <div class="day-number">${current.getDate()}</div>
                        <div class="day-assignments">
                            ${dayAssignments.slice(0, 3).map(a => `
                                <div class="day-assignment ${a.status}">${a.route_name}</div>
                            `).join('')}
                            ${dayAssignments.length > 3 ? `<div style="font-size:10px;color:#666;">+${dayAssignments.length - 3} more</div>` : ''}
                        </div>
                    </div>
                `;

                current.setDate(current.getDate() + 1);
            }

            calendarEl.innerHTML = html;

            // Show assignment form
            document.getElementById('assignment-form').style.display = 'block';
            updateSelectedDatesDisplay();
        }

        function toggleCalendarDate(dateStr) {
            const idx = scheduleState.selectedDates.indexOf(dateStr);
            if (idx === -1) {
                scheduleState.selectedDates.push(dateStr);
            } else {
                scheduleState.selectedDates.splice(idx, 1);
            }

            // Update calendar day styling
            document.querySelectorAll('.calendar-day').forEach(el => {
                const dayNum = el.querySelector('.day-number').textContent;
                const elDate = formatDate(new Date(scheduleState.currentYear, scheduleState.currentMonth, parseInt(dayNum)));
                el.classList.toggle('selected', scheduleState.selectedDates.includes(elDate));
            });

            updateSelectedDatesDisplay();
        }

        function updateSelectedDatesDisplay() {
            const container = document.getElementById('selected-dates');
            if (scheduleState.selectedDates.length === 0) {
                container.innerHTML = '<span style="color:#666;font-size:13px;">Click calendar days to select</span>';
            } else {
                container.innerHTML = scheduleState.selectedDates.sort().map(d => `
                    <span class="selected-date-tag">
                        ${d}
                        <button onclick="removeSelectedDate('${d}')">&times;</button>
                    </span>
                `).join('');
            }
        }

        function removeSelectedDate(dateStr) {
            const idx = scheduleState.selectedDates.indexOf(dateStr);
            if (idx !== -1) {
                scheduleState.selectedDates.splice(idx, 1);
                loadCalendarMonth(); // Refresh to update visuals
            }
        }

        function clearScheduleSelection() {
            scheduleState.selectedDates = [];
            document.getElementById('assign-route-select').value = '';
            document.getElementById('assign-user-select').value = '';
            loadCalendarMonth();
        }

        function prevMonth() {
            scheduleState.currentMonth--;
            if (scheduleState.currentMonth < 0) {
                scheduleState.currentMonth = 11;
                scheduleState.currentYear--;
            }
            loadCalendarMonth();
        }

        function nextMonth() {
            scheduleState.currentMonth++;
            if (scheduleState.currentMonth > 11) {
                scheduleState.currentMonth = 0;
                scheduleState.currentYear++;
            }
            loadCalendarMonth();
        }

        async function createAssignments() {
            const routeId = document.getElementById('assign-route-select').value;
            const userId = document.getElementById('assign-user-select').value;

            if (!routeId) {
                alert('Please select a route');
                return;
            }
            if (!userId) {
                alert('Please select a user');
                return;
            }
            if (scheduleState.selectedDates.length === 0) {
                alert('Please select at least one date');
                return;
            }

            try {
                const response = await authenticatedFetch('/api/schedule/batch', {
                    method: 'POST',
                    body: JSON.stringify({
                        route_id: parseInt(routeId),
                        user_id: parseInt(userId),
                        dates: scheduleState.selectedDates
                    })
                });

                const result = await response.json();
                alert(result.message);

                // Refresh calendar
                scheduleState.selectedDates = [];
                loadCalendarMonth();
            } catch (err) {
                alert('Error creating assignments');
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- My Assignments ---
        function openMyAssignmentsModal() {
            // Set default date to today
            const today = new Date();
            document.getElementById('assignments-date').value = formatDate(today);
            loadMyAssignments();
            document.getElementById('my-assignments-modal').classList.add('active');
        }

        function closeMyAssignmentsModal() {
            document.getElementById('my-assignments-modal').classList.remove('active');
        }

        async function loadMyAssignments() {
            const dateInput = document.getElementById('assignments-date');
            const dateStr = dateInput.value;

            if (!dateStr) return;

            try {
                const response = await authenticatedFetch(`/api/my-routes?date=${dateStr}`);
                const assignments = await response.json();

                const listEl = document.getElementById('my-assignments-list');
                if (assignments.length === 0) {
                    listEl.innerHTML = '<div class="log-empty">No assignments for this date</div>';
                } else {
                    // Need to fetch route details for each assignment
                    const assignmentsWithDetails = await Promise.all(
                        assignments.map(async (a) => {
                            try {
                                const routeRes = await authenticatedFetch(`/api/routes/${a.route_id}`);
                                const route = await routeRes.json();
                                return { ...a, route };
                            } catch {
                                return { ...a, route: null };
                            }
                        })
                    );

                    listEl.innerHTML = assignmentsWithDetails.map(a => {
                        const statusColors = { pending: '#94a3b8', in_progress: '#f59e0b', completed: '#22c55e' };
                        const statusLabels = { pending: 'Pending', in_progress: 'In Progress', completed: 'Completed' };

                        return `
                            <div class="route-item" style="cursor:default;">
                                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                    <div>
                                        <h4>${a.route?.name || 'Route #' + a.route_id}</h4>
                                        <small>${a.route?.clients?.length || '?'} stops</small>
                                    </div>
                                    <span style="background:${statusColors[a.status]};color:white;padding:2px 8px;border-radius:4px;font-size:11px;">
                                        ${statusLabels[a.status]}
                                    </span>
                                </div>
                                ${a.status !== 'completed' ? `
                                    <div style="margin-top:8px;">
                                        <button class="btn btn-success" style="width:auto;padding:6px 12px;font-size:12px;"
                                            onclick="startAssignedRoute(${a.id}, ${a.route_id})">
                                            ${a.status === 'pending' ? 'Start Route' : 'Continue'}
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading assignments:', err);
            }
        }

        async function startAssignedRoute(assignmentId, routeId) {
            // Update status to in_progress
            try {
                await authenticatedFetch(`/api/route-assignments/${assignmentId}/status?status=in_progress`, { method: 'PUT' });
            } catch (err) {
                console.error('Error updating assignment status:', err);
            }

            closeMyAssignmentsModal();
            startRoute(routeId);
        }

        // Update loadRoutes to include save as template button
        async function loadRoutes() {
            const response = await authenticatedFetch('/api/routes');
            const routes = await response.json();

            const listEl = document.getElementById('routes-list');
            if (routes.length === 0) {
                listEl.innerHTML = '<div class="log-empty">No routes yet</div>';
            } else {
                listEl.innerHTML = routes.map(r => `
                    <div class="template-item">
                        <div class="template-info" onclick="startRoute(${r.id})" style="cursor:pointer;flex:1;">
                            <h4>${r.name}</h4>
                            <small>${r.client_count} stops${r.description ? ' - ' + r.description : ''}</small>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-success" onclick="startRoute(${r.id})" title="Execute this route">Run</button>
                            <button class="btn btn-purple" onclick="openSaveAsTemplateModal(${r.id}, '${r.name.replace(/'/g, "\\'")}')">Save</button>
                            <button class="btn btn-danger" onclick="deleteRoute(${r.id})">Del</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function deleteRoute(routeId) {
            if (!confirm('Delete this route?')) return;

            try {
                await authenticatedFetch(`/api/routes/${routeId}`, { method: 'DELETE' });
                loadRoutes();
            } catch (err) {
                alert('Error deleting route');
            }
        }
    </script>
</body>
</html>
